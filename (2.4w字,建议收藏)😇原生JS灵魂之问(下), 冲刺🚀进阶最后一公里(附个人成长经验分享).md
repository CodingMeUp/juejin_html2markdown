[

](/post/5dd8b3a851882572f56b578f)

[](/post/5dd8b3a851882572f56b578f)

2019å¹´11æœˆ25æ—¥é˜…è¯» 41980

(2.4wå­—,å»ºè®®æ”¶è—)ğŸ˜‡åŸç”ŸJSçµé­‚ä¹‹é—®(ä¸‹), å†²åˆºğŸš€è¿›é˜¶æœ€åä¸€å…¬é‡Œ(é™„ä¸ªäººæˆé•¿ç»éªŒåˆ†äº«)
=================================================

ç¬”è€…æœ€è¿‘åœ¨å¯¹åŸç”ŸJSçš„çŸ¥è¯†åšç³»ç»Ÿæ¢³ç†ï¼Œå› ä¸ºæˆ‘è§‰å¾—JSä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆçš„æ ¹æœ¬æŠ€æœ¯ï¼Œå­¦å†å¤šééƒ½ä¸ä¸ºè¿‡ã€‚æ‰“ç®—æ¥åšä¸€ä¸ªç³»åˆ—ï¼Œä¸€å…±åˆ†ä¸‰æ¬¡å‘ï¼Œä»¥ä¸€ç³»åˆ—çš„é—®é¢˜ä¸ºé©±åŠ¨ï¼Œå½“ç„¶ä¹Ÿä¼šæœ‰è¿½é—®å’Œæ‰©å±•ï¼Œå†…å®¹ç³»ç»Ÿä¸”å®Œæ•´ï¼Œå¯¹åˆä¸­çº§é€‰æ‰‹ä¼šæœ‰å¾ˆå¥½çš„æå‡ï¼Œé«˜çº§é€‰æ‰‹ä¹Ÿä¼šå¾—åˆ°å¤ä¹ å’Œå·©å›ºã€‚è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ã€‚

æœ¬æ¬¡åˆ†äº«çš„ä¸»é¢˜æ˜¯`JSæ‰§è¡ŒåŸç†`å’Œ`æ·±å…¥å¼‚æ­¥`ï¼Œæ˜¯ä¸€å—æ¯”è¾ƒç³»ç»Ÿä¸”æœ‰æ·±åº¦çš„å†…å®¹ï¼Œç›¸ä¿¡å¯¹è¿›é˜¶çš„å°ä¼™ä¼´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æå‡ã€‚ä¹‹å‰è¯´è¿‡è¦å†™`è®¾è®¡æ¨¡å¼`ï¼Œä½†ç¬”è€…è¶Šæ¥è¶Šæ„Ÿè§‰è¿™æ˜¯ä¸€å—ç³»ç»Ÿæ€§çš„å·¥ç¨‹ï¼Œç®—ä¸Šå®é™…çš„åº”ç”¨åœºæ™¯ï¼ŒçŸ¥è¯†ä½“é‡ä¸ä¼šäºšäº`JS`æœ¬èº«ï¼Œå› æ­¤æˆ‘æ‰“ç®—ä¹‹åå¦å¤–å¼€ä¸€ä¸ªä¸“é¢˜`ç¨‹åºè®¾è®¡æ¨¡å¼çµé­‚ä¹‹é—®`ï¼Œæ•¬è¯·å…³æ³¨ã€‚

ç¬¬24ç¯‡: JavaScriptå†…å­˜æœºåˆ¶ä¹‹é—®â€”â€”æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ
---------------------------------

ç½‘ä¸Šçš„èµ„æ–™åŸºæœ¬æ˜¯è¿™æ ·è¯´çš„: åŸºæœ¬æ•°æ®ç±»å‹ç”¨`æ ˆ`å­˜å‚¨ï¼Œå¼•ç”¨æ•°æ®ç±»å‹ç”¨`å †`å­˜å‚¨ã€‚

çœ‹èµ·æ¥æ²¡æœ‰é”™è¯¯ï¼Œä½†å®é™…ä¸Šæ˜¯æœ‰é—®é¢˜çš„ã€‚å¯ä»¥è€ƒè™‘ä¸€ä¸‹é—­åŒ…çš„æƒ…å†µï¼Œå¦‚æœå˜é‡å­˜åœ¨æ ˆä¸­ï¼Œé‚£å‡½æ•°è°ƒç”¨å®Œ`æ ˆé¡¶ç©ºé—´é”€æ¯`ï¼Œé—­åŒ…å˜é‡ä¸å°±æ²¡äº†å—ï¼Ÿ

å…¶å®è¿˜æ˜¯éœ€è¦è¡¥å……ä¸€å¥:

> é—­åŒ…å˜é‡æ˜¯å­˜åœ¨å †å†…å­˜ä¸­çš„ã€‚

å…·ä½“è€Œè¨€ï¼Œä»¥ä¸‹æ•°æ®ç±»å‹å­˜å‚¨åœ¨æ ˆä¸­:

*   boolean
*   null
*   undefined
*   number
*   string
*   symbol
*   bigint

è€Œæ‰€æœ‰çš„å¯¹è±¡æ•°æ®ç±»å‹å­˜æ”¾åœ¨å †ä¸­ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº`èµ‹å€¼`æ“ä½œï¼ŒåŸå§‹ç±»å‹çš„æ•°æ®ç›´æ¥å®Œæ•´åœ°å¤åˆ¶å˜é‡å€¼ï¼Œå¯¹è±¡æ•°æ®ç±»å‹çš„æ•°æ®åˆ™æ˜¯å¤åˆ¶å¼•ç”¨åœ°å€ã€‚

å› æ­¤ä¼šæœ‰ä¸‹é¢çš„æƒ…å†µ:

    let obj = { a: 1 };
    let newObj = obj;
    newObj.a = 2;
    console.log(obj.a);//å˜æˆäº†2
    å¤åˆ¶ä»£ç 

ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œæ˜¯å› ä¸º obj å’Œ newObj æ˜¯åŒä¸€ä»½å †ç©ºé—´çš„åœ°å€ï¼Œæ”¹å˜newObjï¼Œç­‰äºæ”¹å˜äº†å…±åŒçš„å †å†…å­˜ï¼Œè¿™æ—¶å€™é€šè¿‡ obj æ¥è·å–è¿™å—å†…å­˜çš„å€¼å½“ç„¶ä¼šæ”¹å˜ã€‚

å½“ç„¶ï¼Œä½ å¯èƒ½ä¼šé—®: ä¸ºä»€ä¹ˆä¸å…¨éƒ¨ç”¨æ ˆæ¥ä¿å­˜å‘¢ï¼Ÿ

é¦–å…ˆï¼Œå¯¹äºç³»ç»Ÿæ ˆæ¥è¯´ï¼Œå®ƒçš„åŠŸèƒ½é™¤äº†ä¿å­˜å˜é‡ä¹‹å¤–ï¼Œè¿˜æœ‰åˆ›å»ºå¹¶åˆ‡æ¢å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„åŠŸèƒ½ã€‚ä¸¾ä¸ªä¾‹å­:

    function f(a) {
      console.log(a);
    }
    
    function func(a) {
      f(a);
    }
    
    func(1);
    å¤åˆ¶ä»£ç 

å‡è®¾ç”¨ESPæŒ‡é’ˆæ¥ä¿å­˜å½“å‰çš„æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨ç³»ç»Ÿæ ˆä¸­ä¼šäº§ç”Ÿå¦‚ä¸‹çš„è¿‡ç¨‹ï¼š

1.  è°ƒç”¨func, å°† func å‡½æ•°çš„ä¸Šä¸‹æ–‡å‹æ ˆï¼ŒESPæŒ‡å‘æ ˆé¡¶ã€‚
    
2.  æ‰§è¡Œfuncï¼Œåˆè°ƒç”¨få‡½æ•°ï¼Œå°† f å‡½æ•°çš„ä¸Šä¸‹æ–‡å‹æ ˆï¼ŒESP æŒ‡é’ˆä¸Šç§»ã€‚
    
3.  æ‰§è¡Œå®Œ f å‡½æ•°ï¼Œå°†ESP ä¸‹ç§»ï¼Œfå‡½æ•°å¯¹åº”çš„æ ˆé¡¶ç©ºé—´è¢«å›æ”¶ã€‚
    
4.  æ‰§è¡Œå®Œ funcï¼ŒESP ä¸‹ç§»ï¼Œfuncå¯¹åº”çš„ç©ºé—´è¢«å›æ”¶ã€‚
    

å›¾ç¤ºå¦‚ä¸‹:

å› æ­¤ä½ ä¹Ÿçœ‹åˆ°äº†ï¼Œå¦‚æœé‡‡ç”¨æ ˆæ¥å­˜å‚¨ç›¸å¯¹åŸºæœ¬ç±»å‹æ›´åŠ å¤æ‚çš„å¯¹è±¡æ•°æ®ï¼Œé‚£ä¹ˆåˆ‡æ¢ä¸Šä¸‹æ–‡çš„å¼€é”€å°†å˜å¾—å·¨å¤§ï¼

ä¸è¿‡å †å†…å­˜è™½ç„¶ç©ºé—´å¤§ï¼Œèƒ½å­˜æ”¾å¤§é‡çš„æ•°æ®ï¼Œä½†ä¸æ­¤åŒæ—¶åƒåœ¾å†…å­˜çš„å›æ”¶ä¼šå¸¦æ¥æ›´å¤§çš„å¼€é”€ï¼Œä¸‹ä¸€ç¯‡å°±æ¥åˆ†æä¸€ä¸‹å †å†…å­˜åˆ°åº•æ˜¯å¦‚ä½•è¿›è¡Œåƒåœ¾å›æ”¶å¹¶è¿›è¡Œä¼˜åŒ–çš„ã€‚

ç¬¬25ç¯‡ï¼šV8 å¼•æ“å¦‚ä½•è¿›è¡Œåƒåœ¾å†…å­˜çš„å›æ”¶ï¼Ÿ
----------------------

JS è¯­è¨€ä¸åƒ C/C++, è®©ç¨‹åºå‘˜è‡ªå·±å»å¼€è¾Ÿæˆ–è€…é‡Šæ”¾å†…å­˜ï¼Œè€Œæ˜¯ç±»ä¼¼Javaï¼Œé‡‡ç”¨è‡ªå·±çš„ä¸€å¥—åƒåœ¾å›æ”¶ç®—æ³•è¿›è¡Œè‡ªåŠ¨çš„å†…å­˜ç®¡ç†ã€‚ä½œä¸ºä¸€åèµ„æ·±çš„å‰ç«¯å·¥ç¨‹å¸ˆï¼Œå¯¹äºJSå†…å­˜å›æ”¶çš„æœºåˆ¶æ˜¯éœ€è¦éå¸¸æ¸…æ¥š, ä»¥ä¾¿äºåœ¨æç«¯çš„ç¯å¢ƒä¸‹èƒ½å¤Ÿåˆ†æå‡ºç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆï¼Œå¦ä¸€æ–¹é¢ï¼Œå­¦ä¹ è¿™å…¶ä¸­çš„æœºåˆ¶ï¼Œä¹Ÿå¯¹æˆ‘ä»¬æ·±å…¥ç†è§£JSçš„é—­åŒ…ç‰¹æ€§ã€ä»¥åŠå¯¹å†…å­˜çš„é«˜æ•ˆä½¿ç”¨ï¼Œéƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

### V8 å†…å­˜é™åˆ¶

åœ¨å…¶ä»–çš„åç«¯è¯­è¨€ä¸­ï¼Œå¦‚Java/Go, å¯¹äºå†…å­˜çš„ä½¿ç”¨æ²¡æœ‰ä»€ä¹ˆé™åˆ¶ï¼Œä½†æ˜¯JSä¸ä¸€æ ·ï¼ŒV8åªèƒ½ä½¿ç”¨ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å†…å­˜ï¼Œå…·ä½“æ¥è¯´ï¼Œåœ¨`64`ä½ç³»ç»Ÿä¸‹ï¼ŒV8æœ€å¤šåªèƒ½åˆ†é…`1.4G`, åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼Œæœ€å¤šåªèƒ½åˆ†é…`0.7G`ã€‚ä½ æƒ³æƒ³åœ¨å‰ç«¯è¿™æ ·çš„å¤§å†…å­˜éœ€æ±‚å…¶å®å¹¶ä¸å¤§ï¼Œä½†å¯¹äºåç«¯è€Œè¨€ï¼Œnodejså¦‚æœé‡åˆ°ä¸€ä¸ª2Gå¤šçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå°†æ— æ³•å…¨éƒ¨å°†å…¶è¯»å…¥å†…å­˜è¿›è¡Œå„ç§æ“ä½œäº†ã€‚

æˆ‘ä»¬çŸ¥é“å¯¹äºæ ˆå†…å­˜è€Œè¨€ï¼Œå½“ESPæŒ‡é’ˆä¸‹ç§»ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹‹åï¼Œæ ˆé¡¶çš„ç©ºé—´ä¼šè‡ªåŠ¨è¢«å›æ”¶ã€‚ä½†å¯¹äºå †å†…å­˜è€Œè¨€å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œæˆ‘ä»¬ä¸‹é¢ç€é‡åˆ†æå †å†…å­˜çš„åƒåœ¾å›æ”¶ã€‚

ä¸Šä¸€ç¯‡æˆ‘ä»¬æåˆ°è¿‡äº†ï¼Œæ‰€æœ‰çš„å¯¹è±¡ç±»å‹çš„æ•°æ®åœ¨JSä¸­éƒ½æ˜¯é€šè¿‡å †è¿›è¡Œç©ºé—´åˆ†é…çš„ã€‚å½“æˆ‘ä»¬æ„é€ ä¸€ä¸ªå¯¹è±¡è¿›è¡Œèµ‹å€¼æ“ä½œçš„æ—¶å€™ï¼Œå…¶å®ç›¸åº”çš„å†…å­˜å·²ç»åˆ†é…åˆ°äº†å †ä¸Šã€‚ä½ å¯ä»¥ä¸æ–­çš„è¿™æ ·åˆ›å»ºå¯¹è±¡ï¼Œè®© V8 ä¸ºå®ƒåˆ†é…ç©ºé—´ï¼Œç›´åˆ°å †çš„å¤§å°è¾¾åˆ°ä¸Šé™ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒV8 ä¸ºä»€ä¹ˆè¦ç»™å®ƒè®¾ç½®å†…å­˜ä¸Šé™ï¼Ÿæ˜æ˜æˆ‘çš„æœºå™¨å¤§å‡ åGçš„å†…å­˜ï¼Œåªèƒ½è®©æˆ‘ç”¨è¿™ä¹ˆä¸€ç‚¹ï¼Ÿ

ç©¶å…¶æ ¹æœ¬ï¼Œæ˜¯ç”±ä¸¤ä¸ªå› ç´ æ‰€å…±åŒå†³å®šçš„ï¼Œä¸€ä¸ªæ˜¯JSå•çº¿ç¨‹çš„æ‰§è¡Œæœºåˆ¶ï¼Œå¦ä¸€ä¸ªæ˜¯JSåƒåœ¾å›æ”¶æœºåˆ¶çš„é™åˆ¶ã€‚

é¦–å…ˆJSæ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦è¿›å…¥åˆ°åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆå…¶å®ƒçš„å„ç§è¿è¡Œé€»è¾‘éƒ½è¦æš‚åœ; å¦ä¸€æ–¹é¢åƒåœ¾å›æ”¶å…¶å®æ˜¯éå¸¸è€—æ—¶é—´çš„æ“ä½œï¼ŒV8 å®˜æ–¹æ˜¯è¿™æ ·å½¢å®¹çš„:

> ä»¥ 1.5GB çš„åƒåœ¾å›æ”¶å †å†…å­˜ä¸ºä¾‹ï¼ŒV8 åšä¸€æ¬¡å°çš„åƒåœ¾å›æ”¶éœ€è¦50ms ä»¥ä¸Šï¼Œåšä¸€æ¬¡éå¢é‡å¼(ps:åé¢ä¼šè§£é‡Š)çš„åƒåœ¾å›æ”¶ç”šè‡³è¦ 1s ä»¥ä¸Šã€‚

å¯è§å…¶è€—æ—¶ä¹‹ä¹…ï¼Œè€Œä¸”åœ¨è¿™ä¹ˆé•¿çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬çš„JSä»£ç æ‰§è¡Œä¼šä¸€ç›´æ²¡æœ‰å“åº”ï¼Œé€ æˆåº”ç”¨å¡é¡¿ï¼Œå¯¼è‡´åº”ç”¨æ€§èƒ½å’Œå“åº”èƒ½åŠ›ç›´çº¿ä¸‹é™ã€‚å› æ­¤ï¼ŒV8 åšäº†ä¸€ä¸ªç®€å•ç²—æš´çš„é€‰æ‹©ï¼Œé‚£å°±æ˜¯é™åˆ¶å †å†…å­˜ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§æƒè¡¡çš„æ‰‹æ®µï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µæ˜¯ä¸ä¼šé‡åˆ°æ“ä½œå‡ ä¸ªGå†…å­˜è¿™æ ·çš„åœºæ™¯çš„ã€‚

ä¸è¿‡ï¼Œå¦‚æœä½ æƒ³è°ƒæ•´è¿™ä¸ªå†…å­˜çš„é™åˆ¶ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚é…ç½®å‘½ä»¤å¦‚ä¸‹:

    // è¿™æ˜¯è°ƒæ•´è€ç”Ÿä»£è¿™éƒ¨åˆ†çš„å†…å­˜ï¼Œå•ä½æ˜¯MBã€‚åé¢ä¼šè¯¦ç»†ä»‹ç»æ–°ç”Ÿä»£å’Œè€ç”Ÿä»£å†…å­˜
    node --max-old-space-size=2048 xxx.js 
    å¤åˆ¶ä»£ç 

æˆ–è€…

    // è¿™æ˜¯è°ƒæ•´æ–°ç”Ÿä»£è¿™éƒ¨åˆ†çš„å†…å­˜ï¼Œå•ä½æ˜¯ KBã€‚
    node --max-new-space-size=2048 xxx.js
    å¤åˆ¶ä»£ç 

### æ–°ç”Ÿä»£å†…å­˜çš„å›æ”¶

V8 æŠŠå †å†…å­˜åˆ†æˆäº†ä¸¤éƒ¨åˆ†è¿›è¡Œå¤„ç†â€”â€”æ–°ç”Ÿä»£å†…å­˜å’Œè€ç”Ÿä»£å†…å­˜ã€‚é¡¾åæ€ä¹‰ï¼Œæ–°ç”Ÿä»£å°±æ˜¯ä¸´æ—¶åˆ†é…çš„å†…å­˜ï¼Œå­˜æ´»æ—¶é—´çŸ­ï¼Œ è€ç”Ÿä»£æ˜¯å¸¸é©»å†…å­˜ï¼Œå­˜æ´»çš„æ—¶é—´é•¿ã€‚V8 çš„å †å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªå†…å­˜ä¹‹å’Œã€‚

æ ¹æ®è¿™ä¸¤ç§ä¸åŒç§ç±»çš„å †å†…å­˜ï¼ŒV8 é‡‡ç”¨äº†ä¸åŒçš„å›æ”¶ç­–ç•¥ï¼Œæ¥æ ¹æ®ä¸åŒçš„åœºæ™¯åšé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚

é¦–å…ˆæ˜¯æ–°ç”Ÿä»£çš„å†…å­˜ï¼Œåˆšåˆšå·²ç»ä»‹ç»äº†è°ƒæ•´æ–°ç”Ÿä»£å†…å­˜çš„æ–¹æ³•ï¼Œé‚£å®ƒçš„å†…å­˜é»˜è®¤é™åˆ¶æ˜¯å¤šå°‘ï¼Ÿåœ¨ 64 ä½å’Œ 32 ä½ç³»ç»Ÿä¸‹åˆ†åˆ«ä¸º 32MB å’Œ 16MBã€‚å¤Ÿå°å§ï¼Œä¸è¿‡ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ–°ç”Ÿä»£ä¸­çš„å˜é‡å­˜æ´»æ—¶é—´çŸ­ï¼Œæ¥äº†é©¬ä¸Šå°±èµ°ï¼Œä¸å®¹æ˜“äº§ç”Ÿå¤ªå¤§çš„å†…å­˜è´Ÿæ‹…ï¼Œå› æ­¤å¯ä»¥å°†å®ƒè®¾çš„è¶³å¤Ÿå°ã€‚

é‚£å¥½äº†ï¼Œæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ

é¦–å…ˆå°†æ–°ç”Ÿä»£å†…å­˜ç©ºé—´ä¸€åˆ†ä¸ºäºŒ:

å…¶ä¸­Froméƒ¨åˆ†è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨çš„å†…å­˜ï¼ŒTo æ˜¯ç›®å‰é—²ç½®çš„å†…å­˜ã€‚

å½“è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼ŒV8 å°†Froméƒ¨åˆ†çš„å¯¹è±¡æ£€æŸ¥ä¸€éï¼Œå¦‚æœæ˜¯å­˜æ´»å¯¹è±¡é‚£ä¹ˆå¤åˆ¶åˆ°Toå†…å­˜ä¸­(åœ¨Toå†…å­˜ä¸­æŒ‰ç…§é¡ºåºä»å¤´æ”¾ç½®çš„)ï¼Œå¦‚æœæ˜¯éå­˜æ´»å¯¹è±¡ç›´æ¥å›æ”¶å³å¯ã€‚

å½“æ‰€æœ‰çš„Fromä¸­çš„å­˜æ´»å¯¹è±¡æŒ‰ç…§é¡ºåºè¿›å…¥åˆ°Toå†…å­˜ä¹‹åï¼ŒFrom å’Œ To ä¸¤è€…çš„è§’è‰²`å¯¹è°ƒ`ï¼ŒFromç°åœ¨è¢«é—²ç½®ï¼ŒToä¸ºæ­£åœ¨ä½¿ç”¨ï¼Œå¦‚æ­¤å¾ªç¯ã€‚

é‚£ä½ å¾ˆå¯èƒ½ä¼šé—®äº†ï¼Œç›´æ¥å°†éå­˜æ´»å¯¹è±¡å›æ”¶äº†ä¸å°±ä¸‡äº‹å¤§å‰äº†å˜›ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åé¢çš„ä¸€ç³»åˆ—æ“ä½œï¼Ÿ

æ³¨æ„ï¼Œæˆ‘åˆšåˆšç‰¹åˆ«è¯´æ˜äº†ï¼Œåœ¨Toå†…å­˜ä¸­æŒ‰ç…§é¡ºåºä»å¤´æ”¾ç½®çš„ï¼Œè¿™æ˜¯ä¸ºäº†åº”å¯¹è¿™æ ·çš„åœºæ™¯:

æ·±è‰²çš„å°æ–¹å—ä»£è¡¨å­˜æ´»å¯¹è±¡ï¼Œç™½è‰²éƒ¨åˆ†è¡¨ç¤ºå¾…åˆ†é…çš„å†…å­˜ï¼Œç”±äºå †å†…å­˜æ˜¯è¿ç»­åˆ†é…çš„ï¼Œè¿™æ ·é›¶é›¶æ•£æ•£çš„ç©ºé—´å¯èƒ½ä¼šå¯¼è‡´ç¨å¾®å¤§ä¸€ç‚¹çš„å¯¹è±¡æ²¡æœ‰åŠæ³•è¿›è¡Œç©ºé—´åˆ†é…ï¼Œè¿™ç§é›¶æ•£çš„ç©ºé—´ä¹Ÿå«åš**å†…å­˜ç¢ç‰‡**ã€‚åˆšåˆšä»‹ç»çš„æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ç®—æ³•ä¹Ÿå«**Scavengeç®—æ³•**ã€‚

Scavenge ç®—æ³•ä¸»è¦å°±æ˜¯è§£å†³å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œåœ¨è¿›è¡Œä¸€é¡¿å¤åˆ¶ä¹‹åï¼ŒToç©ºé—´å˜æˆäº†è¿™ä¸ªæ ·å­:

æ˜¯ä¸æ˜¯æ•´é½äº†è®¸å¤šï¼Ÿè¿™æ ·å°±å¤§å¤§æ–¹ä¾¿äº†åç»­è¿ç»­ç©ºé—´çš„åˆ†é…ã€‚

ä¸è¿‡Scavenge ç®—æ³•çš„åŠ£åŠ¿ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œå°±æ˜¯å†…å­˜åªèƒ½ä½¿ç”¨æ–°ç”Ÿä»£å†…å­˜çš„ä¸€åŠï¼Œä½†æ˜¯å®ƒåªå­˜æ”¾ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡`ä¸€èˆ¬å¾ˆå°‘`ï¼Œå› æ­¤`æ—¶é—´`æ€§èƒ½éå¸¸ä¼˜ç§€ã€‚

### è€ç”Ÿä»£å†…å­˜çš„å›æ”¶

åˆšåˆšä»‹ç»äº†æ–°ç”Ÿä»£çš„å›æ”¶æ–¹å¼ï¼Œé‚£ä¹ˆæ–°ç”Ÿä»£ä¸­çš„å˜é‡å¦‚æœç»è¿‡å¤šæ¬¡å›æ”¶åä¾ç„¶å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¼šè¢«æ”¾å…¥åˆ°`è€ç”Ÿä»£å†…å­˜`ä¸­ï¼Œè¿™ç§ç°è±¡å°±å«`æ™‹å‡`ã€‚

å‘ç”Ÿæ™‹å‡å…¶å®ä¸åªæ˜¯è¿™ä¸€ç§åŸå› ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ä¼šæœ‰é‚£äº›æƒ…å†µè§¦å‘æ™‹å‡:

*   å·²ç»ç»å†è¿‡ä¸€æ¬¡ Scavenge å›æ”¶ã€‚
*   Toï¼ˆé—²ç½®ï¼‰ç©ºé—´çš„å†…å­˜å ç”¨è¶…è¿‡25%ã€‚

ç°åœ¨è¿›å…¥åˆ°è€ç”Ÿä»£çš„åƒåœ¾å›æ”¶æœºåˆ¶å½“ä¸­ï¼Œè€ç”Ÿä»£ä¸­ç´¯ç§¯çš„å˜é‡ç©ºé—´ä¸€èˆ¬éƒ½æ˜¯å¾ˆå¤§çš„ï¼Œå½“ç„¶ä¸èƒ½ç”¨`Scavenge`ç®—æ³•å•¦ï¼Œæµªè´¹ä¸€åŠç©ºé—´ä¸è¯´ï¼Œå¯¹åºå¤§çš„å†…å­˜ç©ºé—´è¿›è¡Œå¤åˆ¶å²‚ä¸æ˜¯åŠ³æ°‘ä¼¤è´¢ï¼Ÿ

é‚£ä¹ˆå¯¹äºè€ç”Ÿä»£è€Œè¨€ï¼Œç©¶ç«Ÿæ˜¯é‡‡å–æ€æ ·çš„ç­–ç•¥è¿›è¡Œåƒåœ¾å›æ”¶çš„å‘¢ï¼Ÿ

ç¬¬ä¸€æ­¥ï¼Œè¿›è¡Œæ ‡è®°-æ¸…é™¤ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨ã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡(ç¬¬ä¸‰ç‰ˆ)ã€‹ä¸­æœ‰è¿‡è¯¦ç»†çš„ä»‹ç»ï¼Œä¸»è¦åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œå³æ ‡è®°é˜¶æ®µå’Œæ¸…é™¤é˜¶æ®µã€‚é¦–å…ˆä¼šéå†å †ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œå¯¹å®ƒä»¬åšä¸Šæ ‡è®°ï¼Œç„¶åå¯¹äºä»£ç ç¯å¢ƒä¸­`ä½¿ç”¨çš„å˜é‡`ä»¥åŠè¢«`å¼ºå¼•ç”¨`çš„å˜é‡å–æ¶ˆæ ‡è®°ï¼Œå‰©ä¸‹çš„å°±æ˜¯è¦åˆ é™¤çš„å˜é‡äº†ï¼Œåœ¨éšåçš„`æ¸…é™¤é˜¶æ®µ`å¯¹å…¶è¿›è¡Œç©ºé—´çš„å›æ”¶ã€‚

å½“ç„¶è¿™åˆä¼šå¼•å‘å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œå­˜æ´»å¯¹è±¡çš„ç©ºé—´ä¸è¿ç»­å¯¹åç»­çš„ç©ºé—´åˆ†é…é€ æˆéšœç¢ã€‚è€ç”Ÿä»£åˆæ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ

ç¬¬äºŒæ­¥ï¼Œæ•´ç†å†…å­˜ç¢ç‰‡ã€‚V8 çš„è§£å†³æ–¹å¼éå¸¸ç®€å•ç²—æš´ï¼Œåœ¨æ¸…é™¤é˜¶æ®µç»“æŸåï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡å…¨éƒ¨å¾€ä¸€ç«¯é æ‹¢ã€‚

ç”±äºæ˜¯ç§»åŠ¨å¯¹è±¡ï¼Œå®ƒçš„æ‰§è¡Œé€Ÿåº¦ä¸å¯èƒ½å¾ˆå¿«ï¼Œäº‹å®ä¸Šä¹Ÿæ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­æœ€è€—æ—¶é—´çš„éƒ¨åˆ†ã€‚

### å¢é‡æ ‡è®°

ç”±äºJSçš„å•çº¿ç¨‹æœºåˆ¶ï¼ŒV8 åœ¨è¿›è¡Œåƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œä¸å¯é¿å…åœ°ä¼šé˜»å¡ä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œï¼Œå€˜è‹¥è€ç”Ÿä»£çš„åƒåœ¾å›æ”¶ä»»åŠ¡å¾ˆé‡ï¼Œé‚£ä¹ˆè€—æ—¶ä¼šéå¸¸å¯æ€•ï¼Œä¸¥é‡å½±å“åº”ç”¨çš„æ€§èƒ½ã€‚é‚£è¿™ä¸ªæ—¶å€™ä¸ºäº†é¿å…è¿™æ ·é—®é¢˜ï¼ŒV8 é‡‡å–äº†å¢é‡æ ‡è®°çš„æ–¹æ¡ˆï¼Œå³å°†ä¸€å£æ°”å®Œæˆçš„æ ‡è®°ä»»åŠ¡åˆ†ä¸ºå¾ˆå¤šå°çš„éƒ¨åˆ†å®Œæˆï¼Œæ¯åšå®Œä¸€ä¸ªå°çš„éƒ¨åˆ†å°±"æ­‡"ä¸€ä¸‹ï¼Œå°±jsåº”ç”¨é€»è¾‘æ‰§è¡Œä¸€ä¼šå„¿ï¼Œç„¶åå†æ‰§è¡Œä¸‹é¢çš„éƒ¨åˆ†ï¼Œå¦‚æœå¾ªç¯ï¼Œç›´åˆ°æ ‡è®°é˜¶æ®µå®Œæˆæ‰è¿›å…¥å†…å­˜ç¢ç‰‡çš„æ•´ç†ä¸Šé¢æ¥ã€‚å…¶å®è¿™ä¸ªè¿‡ç¨‹è·ŸReact Fiberçš„æ€è·¯æœ‰ç‚¹åƒï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚

ç»è¿‡å¢é‡æ ‡è®°ä¹‹åï¼Œåƒåœ¾å›æ”¶è¿‡ç¨‹å¯¹JSåº”ç”¨çš„é˜»å¡æ—¶é—´å‡å°‘åˆ°åŸæ¥äº†1 / 6, å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æˆåŠŸçš„æ”¹è¿›ã€‚

JSåƒåœ¾å›æ”¶çš„åŸç†å°±ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œå…¶å®ç†è§£èµ·æ¥æ˜¯éå¸¸ç®€å•çš„ï¼Œé‡è¦çš„æ˜¯ç†è§£å®ƒ`ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš`ï¼Œè€Œä¸ä»…ä»…æ˜¯`å¦‚ä½•åšçš„`ï¼Œå¸Œæœ›è¿™ç¯‡æ€»ç»“èƒ½å¤Ÿå¯¹ä½ æœ‰æ‰€å¯å‘ã€‚

ç¬¬26ç¯‡: æè¿°ä¸€ä¸‹ V8 æ‰§è¡Œä¸€æ®µJSä»£ç çš„è¿‡ç¨‹ï¼Ÿ
--------------------------

å‰ç«¯ç›¸å¯¹æ¥è¯´æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–°å…´çš„é¢†åŸŸï¼Œå› æ­¤å„ç§å‰ç«¯æ¡†æ¶å’Œå·¥å…·å±‚å‡ºä¸ç©·ï¼Œè®©äººçœ¼èŠ±ç¼­ä¹±ï¼Œå°¤å…¶æ˜¯å„å¤§å‚å•†æ¨å‡º`å°ç¨‹åº`ä¹‹å`å„è‡ªåˆ¶å®šæ ‡å‡†`ï¼Œè®©å‰ç«¯å¼€å‘çš„å·¥ä½œæ›´åŠ ç¹çï¼Œåœ¨æ­¤èƒŒæ™¯ä¸‹ä¸ºäº†æŠ¹å¹³å¹³å°ä¹‹é—´çš„å·®å¼‚ï¼Œè¯ç”Ÿçš„å„ç§`ç¼–è¯‘å·¥å…·/æ¡†æ¶`ä¹Ÿæ•°ä¸èƒœæ•°ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œæƒ³è¦èµ¶ä¸Šè¿™äº›æ¡†æ¶å’Œå·¥å…·çš„æ›´æ–°é€Ÿåº¦æ˜¯éå¸¸éš¾çš„ï¼Œå³ä½¿èµ¶ä¸Šäº†ä¹Ÿå¾ˆéš¾äº§ç”Ÿè‡ªå·±çš„`æŠ€æœ¯ç§¯æ·€`ï¼Œä¸€ä¸ªæ›´å¥½çš„æ–¹å¼ä¾¿æ˜¯å­¦ä¹ é‚£äº›`æœ¬è´¨çš„çŸ¥è¯†`ï¼ŒæŠ“ä½ä¸Šå±‚åº”ç”¨ä¸­ä¸å˜çš„`åº•å±‚æœºåˆ¶`ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½è½»æ¾ç†è§£ä¸Šå±‚çš„æ¡†æ¶è€Œä¸ä»…ä»…æ˜¯è¢«åŠ¨åœ°ä½¿ç”¨ï¼Œç”šè‡³èƒ½å¤Ÿåœ¨é€‚å½“çš„åœºæ™¯ä¸‹è‡ªå·±é€ å‡ºè½®å­ï¼Œä»¥æ»¡è¶³å¼€å‘æ•ˆç‡çš„éœ€æ±‚ã€‚

ç«™åœ¨ V8 çš„è§’åº¦ï¼Œç†è§£å…¶ä¸­çš„æ‰§è¡Œæœºåˆ¶ï¼Œä¹Ÿèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ç†è§£å¾ˆå¤šçš„ä¸Šå±‚åº”ç”¨ï¼ŒåŒ…æ‹¬Babelã€Eslintã€å‰ç«¯æ¡†æ¶çš„åº•å±‚æœºåˆ¶ã€‚é‚£ä¹ˆï¼Œä¸€æ®µ JavaScript ä»£ç æ”¾åœ¨ V8 å½“ä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ï¼Ÿ

é¦–å…ˆéœ€è¦æ˜ç™½çš„æ˜¯ï¼Œæœºå™¨æ˜¯è¯»ä¸æ‡‚ JS ä»£ç ï¼Œæœºå™¨åªèƒ½ç†è§£ç‰¹å®šçš„æœºå™¨ç ï¼Œé‚£å¦‚æœè¦è®© JS çš„é€»è¾‘åœ¨æœºå™¨ä¸Šè¿è¡Œèµ·æ¥ï¼Œå°±å¿…é¡»å°† JS çš„ä»£ç ç¿»è¯‘æˆæœºå™¨ç ï¼Œç„¶åè®©æœºå™¨è¯†åˆ«ã€‚JSå±äºè§£é‡Šå‹è¯­è¨€ï¼Œå¯¹äºè§£é‡Šå‹çš„è¯­è¨€è¯´ï¼Œè§£é‡Šå™¨ä¼šå¯¹æºä»£ç åšå¦‚ä¸‹åˆ†æ:

*   é€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æç”Ÿæˆ AST(æŠ½è±¡è¯­æ³•æ ‘)
*   ç”Ÿæˆå­—èŠ‚ç 

ç„¶åè§£é‡Šå™¨æ ¹æ®å­—èŠ‚ç æ¥æ‰§è¡Œç¨‹åºã€‚ä½† JS æ•´ä¸ªæ‰§è¡Œçš„è¿‡ç¨‹å…¶å®ä¼šæ¯”è¿™ä¸ªæ›´åŠ å¤æ‚ï¼Œæ¥ä¸‹æ¥å°±æ¥ä¸€ä¸€åœ°æ‹†è§£ã€‚

### 1.ç”Ÿæˆ AST

ç”Ÿæˆ AST åˆ†ä¸ºä¸¤æ­¥â€”â€”è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æã€‚

è¯æ³•åˆ†æå³åˆ†è¯ï¼Œå®ƒçš„å·¥ä½œå°±æ˜¯å°†ä¸€è¡Œè¡Œçš„ä»£ç åˆ†è§£æˆä¸€ä¸ªä¸ªtokenã€‚ æ¯”å¦‚ä¸‹é¢ä¸€è¡Œä»£ç :

    let name = 'sanyuan'
    å¤åˆ¶ä»£ç 

å…¶ä¸­ä¼šæŠŠå¥å­åˆ†è§£æˆå››ä¸ªéƒ¨åˆ†:

å³è§£ææˆäº†å››ä¸ªtokenï¼Œè¿™å°±æ˜¯è¯æ³•åˆ†æçš„ä½œç”¨ã€‚

æ¥ä¸‹æ¥è¯­æ³•åˆ†æé˜¶æ®µï¼Œå°†ç”Ÿæˆçš„è¿™äº› token æ•°æ®ï¼Œæ ¹æ®ä¸€å®šçš„è¯­æ³•è§„åˆ™è½¬åŒ–ä¸ºASTã€‚ä¸¾ä¸ªä¾‹å­:

    let name = 'sanyuan'
    console.log(name)
    å¤åˆ¶ä»£ç 

æœ€åç”Ÿæˆçš„ AST æ˜¯è¿™æ ·çš„:

å½“ç”Ÿæˆäº† AST ä¹‹åï¼Œç¼–è¯‘å™¨/è§£é‡Šå™¨åç»­çš„å·¥ä½œéƒ½è¦ä¾é  AST è€Œä¸æ˜¯æºä»£ç ã€‚é¡ºä¾¿è¡¥å……ä¸€å¥ï¼Œbabel çš„å·¥ä½œåŸç†å°±æ˜¯å°† ES6 çš„ä»£ç è§£æç”Ÿæˆ`ES6çš„AST`ï¼Œç„¶åå°† ES6 çš„ AST è½¬æ¢ä¸º `ES5 çš„AST`,æœ€åæ‰å°† ES5 çš„ AST è½¬åŒ–ä¸ºå…·ä½“çš„ ES5 ä»£ç ã€‚ç”±äºæœ¬æ–‡ç€é‡é˜è¿°åŸç†ï¼Œå…³äº babel ç¼–è¯‘çš„ç»†èŠ‚å°±ä¸å±•å¼€äº†ï¼Œæ¨èå¤§å®¶å»è¯»ä¸€è¯»è’å±±çš„[babelæ–‡ç« ](https://juejin.im/post/5d94bfbf5188256db95589be), å¸®ä½ æ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨: )

å›åˆ° V8 æœ¬èº«ï¼Œç”Ÿæˆ AST åï¼Œæ¥ä¸‹æ¥ä¼šç”Ÿæˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå…³äºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å‚è€ƒä¸Šä¸Šç¯‡ã€ŠJavaScriptå†…å­˜æœºåˆ¶ä¹‹é—®â€”â€”æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿã€‹ä¸­å¯¹äºä¸Šä¸‹æ–‡å‹æ ˆå‡ºæ ˆè¿‡ç¨‹çš„è®²è§£ã€‚

### 2\. ç”Ÿæˆå­—èŠ‚ç 

å¼€å¤´å°±å·²ç»æåˆ°è¿‡äº†ï¼Œç”Ÿæˆ AST ä¹‹åï¼Œç›´æ¥é€šè¿‡ V8 çš„è§£é‡Šå™¨(ä¹Ÿå«Ignition)æ¥ç”Ÿæˆå­—èŠ‚ç ã€‚ä½†æ˜¯`å­—èŠ‚ç `å¹¶ä¸èƒ½è®©æœºå™¨ç›´æ¥è¿è¡Œï¼Œé‚£ä½ å¯èƒ½å°±ä¼šè¯´äº†ï¼Œä¸èƒ½æ‰§è¡Œè¿˜è½¬æˆå­—èŠ‚ç å¹²å˜›ï¼Œç›´æ¥æŠŠ AST è½¬æ¢æˆæœºå™¨ç ä¸å°±å¾—äº†ï¼Œè®©æœºå™¨ç›´æ¥æ‰§è¡Œã€‚ç¡®å®ï¼Œåœ¨ V8 çš„æ—©æœŸæ˜¯è¿™ä¹ˆåšçš„ï¼Œä½†åæ¥å› ä¸ºæœºå™¨ç çš„ä½“ç§¯å¤ªå¤§ï¼Œå¼•å‘äº†ä¸¥é‡çš„å†…å­˜å ç”¨é—®é¢˜ã€‚

ç»™ä¸€å¼ å¯¹æ¯”å›¾è®©å¤§å®¶ç›´è§‚åœ°æ„Ÿå—ä»¥ä¸‹ä¸‰è€…ä»£ç é‡çš„å·®å¼‚:

å¾ˆå®¹æ˜“å¾—å‡ºï¼Œå­—èŠ‚ç æ˜¯æ¯”æœºå™¨ç è½»é‡å¾—å¤šçš„ä»£ç ã€‚é‚£ V8 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å­—èŠ‚ç ï¼Œå­—èŠ‚ç åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ

> å­èŠ‚ç æ˜¯ä»‹äºAST å’Œ æœºå™¨ç ä¹‹é—´çš„ä¸€ç§ä»£ç ï¼Œä½†æ˜¯ä¸ç‰¹å®šç±»å‹çš„æœºå™¨ç æ— å…³ï¼Œå­—èŠ‚ç éœ€è¦é€šè¿‡è§£é‡Šå™¨å°†å…¶è½¬æ¢ä¸ºæœºå™¨ç ç„¶åæ‰§è¡Œã€‚

å­—èŠ‚ç ä»ç„¶éœ€è¦è½¬æ¢ä¸ºæœºå™¨ç ï¼Œä½†å’ŒåŸæ¥ä¸åŒçš„æ˜¯ï¼Œç°åœ¨ä¸ç”¨ä¸€æ¬¡æ€§å°†å…¨éƒ¨çš„å­—èŠ‚ç éƒ½è½¬æ¢æˆæœºå™¨ç ï¼Œè€Œæ˜¯é€šè¿‡è§£é‡Šå™¨æ¥é€è¡Œæ‰§è¡Œå­—èŠ‚ç ï¼Œçœå»äº†ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„æ“ä½œï¼Œè¿™æ ·å°±å¤§å¤§é™ä½äº†å†…å­˜çš„å‹åŠ›ã€‚

### 3\. æ‰§è¡Œä»£ç 

æ¥ä¸‹æ¥ï¼Œå°±è¿›å…¥åˆ°å­—èŠ‚ç è§£é‡Šæ‰§è¡Œçš„é˜¶æ®µå•¦ï¼

åœ¨æ‰§è¡Œå­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç°æŸä¸€éƒ¨åˆ†ä»£ç é‡å¤å‡ºç°ï¼Œé‚£ä¹ˆ V8 å°†å®ƒè®°åš`çƒ­ç‚¹ä»£ç `(HotSpot)ï¼Œç„¶åå°†è¿™ä¹ˆä»£ç ç¼–è¯‘æˆ`æœºå™¨ç `ä¿å­˜èµ·æ¥ï¼Œè¿™ä¸ªç”¨æ¥ç¼–è¯‘çš„å·¥å…·å°±æ˜¯V8çš„`ç¼–è¯‘å™¨`(ä¹Ÿå«åš`TurboFan`) , å› æ­¤åœ¨è¿™æ ·çš„æœºåˆ¶ä¸‹ï¼Œä»£ç æ‰§è¡Œçš„æ—¶é—´è¶Šä¹…ï¼Œé‚£ä¹ˆæ‰§è¡Œæ•ˆç‡ä¼šè¶Šæ¥è¶Šé«˜ï¼Œå› ä¸ºæœ‰è¶Šæ¥è¶Šå¤šçš„å­—èŠ‚ç è¢«æ ‡è®°ä¸º`çƒ­ç‚¹ä»£ç `ï¼Œé‡åˆ°å®ƒä»¬æ—¶ç›´æ¥æ‰§è¡Œç›¸åº”çš„æœºå™¨ç ï¼Œä¸ç”¨å†æ¬¡å°†è½¬æ¢ä¸ºæœºå™¨ç ã€‚

å…¶å®å½“ä½ å¬åˆ°æœ‰äººè¯´ JS å°±æ˜¯ä¸€é—¨è§£é‡Šå™¨è¯­è¨€çš„æ—¶å€™ï¼Œå…¶å®è¿™ä¸ªè¯´æ³•æ˜¯æœ‰é—®é¢˜çš„ã€‚å› ä¸ºå­—èŠ‚ç ä¸ä»…é…åˆäº†è§£é‡Šå™¨ï¼Œè€Œä¸”è¿˜å’Œç¼–è¯‘å™¨æ‰“äº¤é“ï¼Œæ‰€ä»¥ JS å¹¶ä¸æ˜¯å®Œå…¨çš„è§£é‡Šå‹è¯­è¨€ã€‚è€Œç¼–è¯‘å™¨å’Œè§£é‡Šå™¨çš„ æ ¹æœ¬åŒºåˆ«åœ¨äºå‰è€…ä¼šç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ä½†åè€…ä¸ä¼šã€‚

å¹¶ä¸”ï¼Œè¿™ç§å­—èŠ‚ç è·Ÿç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ç»“åˆçš„æŠ€æœ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`å³æ—¶ç¼–è¯‘`, ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„`JIT`ã€‚

è¿™å°±æ˜¯ V8 ä¸­æ‰§è¡Œä¸€æ®µJSä»£ç çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ¢³ç†ä¸€ä¸‹:

1.  é¦–å…ˆé€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æç”Ÿæˆ `AST`
2.  å°† AST è½¬æ¢ä¸ºå­—èŠ‚ç 
3.  ç”±è§£é‡Šå™¨é€è¡Œæ‰§è¡Œå­—èŠ‚ç ï¼Œé‡åˆ°çƒ­ç‚¹ä»£ç å¯åŠ¨ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆå¯¹åº”çš„æœºå™¨ç , ä»¥ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡

å…³äºè¿™ä¸ªé—®é¢˜çš„æ‹†è§£å°±åˆ°è¿™é‡Œï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¯å‘ã€‚

ç¬¬28ç¯‡ï¼šå¦‚ä½•ç†è§£EventLoopâ€”â€”å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ç¯‡
----------------------------

### å®ä»»åŠ¡(MacroTask)å¼•å…¥

åœ¨ JS ä¸­ï¼Œå¤§éƒ¨åˆ†çš„ä»»åŠ¡éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¸¸è§çš„ä»»åŠ¡æœ‰:

1.  æ¸²æŸ“äº‹ä»¶
2.  ç”¨æˆ·äº¤äº’äº‹ä»¶
3.  jsè„šæœ¬æ‰§è¡Œ
4.  ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™å®Œæˆäº‹ä»¶ç­‰ç­‰ã€‚

ä¸ºäº†è®©è¿™äº›äº‹ä»¶æœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œï¼ŒJSå¼•æ“éœ€è¦å¯¹ä¹‹æ‰§è¡Œçš„é¡ºåºåšä¸€å®šçš„å®‰æ’ï¼ŒV8 å…¶å®é‡‡ç”¨çš„æ˜¯ä¸€ç§`é˜Ÿåˆ—`çš„æ–¹å¼æ¥å­˜å‚¨è¿™äº›ä»»åŠ¡ï¼Œ å³å…ˆè¿›æ¥çš„å…ˆæ‰§è¡Œã€‚æ¨¡æ‹Ÿå¦‚ä¸‹:

    bool keep_running = true;
    void MainTherad(){
      for(;;){
        //æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
        Task task = task_queue.takeTask();
        ProcessTask(task);
        
        //æ‰§è¡Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
        ProcessDelayTask()
    
        if(!keep_running) //å¦‚æœè®¾ç½®äº†é€€å‡ºæ ‡å¿—ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºçº¿ç¨‹å¾ªç¯
            break; 
      }
    }
    å¤åˆ¶ä»£ç 

è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ª for å¾ªç¯ï¼Œå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€ä¸€å–å‡ºï¼Œç„¶åæ‰§è¡Œï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚ä½†æ˜¯å…¶ä¸­åŒ…å«äº†ä¸¤ç§ä»»åŠ¡é˜Ÿåˆ—ï¼Œé™¤äº†ä¸Šè¿°æåˆ°çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œ è¿˜æœ‰ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—ï¼Œå®ƒä¸“é—¨å¤„ç†è¯¸å¦‚setTimeout/setIntervalè¿™æ ·çš„å®šæ—¶å™¨å›è°ƒä»»åŠ¡ã€‚

ä¸Šè¿°æåˆ°çš„ï¼Œæ™®é€šä»»åŠ¡é˜Ÿåˆ—å’Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéƒ½å±äº**å®ä»»åŠ¡**ã€‚

### å¾®ä»»åŠ¡(MicroTask)å¼•å…¥

å¯¹äºæ¯ä¸ªå®ä»»åŠ¡è€Œè¨€ï¼Œå…¶å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚é‚£ä¸ºä»€ä¹ˆè¦å¼•å…¥å¾®ä»»åŠ¡ï¼Ÿå¾®ä»»åŠ¡åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿ

å…¶å®å¼•å…¥å¾®ä»»åŠ¡çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥å›è°ƒçš„é—®é¢˜ã€‚æƒ³ä¸€æƒ³ï¼Œå¯¹äºå¼‚æ­¥å›è°ƒçš„å¤„ç†ï¼Œæœ‰å¤šå°‘ç§æ–¹å¼ï¼Ÿæ€»ç»“èµ·æ¥æœ‰ä¸¤ç‚¹:

1.  å°†å¼‚æ­¥å›è°ƒè¿›è¡Œå®ä»»åŠ¡é˜Ÿåˆ—çš„å…¥é˜Ÿæ“ä½œã€‚
2.  å°†å¼‚æ­¥å›è°ƒæ”¾åˆ°å½“å‰å®ä»»åŠ¡çš„æœ«å°¾ã€‚

å¦‚æœé‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œé‚£ä¹ˆæ‰§è¡Œå›è°ƒçš„æ—¶æœºåº”è¯¥æ˜¯åœ¨å‰é¢`æ‰€æœ‰çš„å®ä»»åŠ¡`å®Œæˆä¹‹åï¼Œå€˜è‹¥ç°åœ¨çš„ä»»åŠ¡é˜Ÿåˆ—éå¸¸é•¿ï¼Œé‚£ä¹ˆå›è°ƒè¿Ÿè¿Ÿå¾—ä¸åˆ°æ‰§è¡Œï¼Œé€ æˆ`åº”ç”¨å¡é¡¿`ã€‚

ä¸ºäº†è§„é¿è¿™æ ·çš„é—®é¢˜ï¼ŒV8 å¼•å…¥äº†ç¬¬äºŒç§æ–¹å¼ï¼Œè¿™å°±æ˜¯`å¾®ä»»åŠ¡`çš„è§£å†³æ–¹å¼ã€‚åœ¨æ¯ä¸€ä¸ªå®ä»»åŠ¡ä¸­å®šä¹‰ä¸€ä¸ª**å¾®ä»»åŠ¡é˜Ÿåˆ—**ï¼Œå½“è¯¥å®ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œä¼šæ£€æŸ¥å…¶ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœä¸ºç©ºåˆ™ç›´æ¥æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™`ä¾æ¬¡æ‰§è¡Œå¾®ä»»åŠ¡`ï¼Œæ‰§è¡Œå®Œæˆæ‰å»æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚

å¸¸è§çš„å¾®ä»»åŠ¡æœ‰MutationObserverã€Promise.then(æˆ–.reject) ä»¥åŠä»¥ Promise ä¸ºåŸºç¡€å¼€å‘çš„å…¶ä»–æŠ€æœ¯(æ¯”å¦‚fetch API), è¿˜åŒ…æ‹¬ V8 çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚

Ok, è¿™ä¾¿æ˜¯`å®ä»»åŠ¡`å’Œ`å¾®ä»»åŠ¡`çš„æ¦‚å¿µï¼Œæ¥ä¸‹æ¥æ­£å¼ä»‹ç»JSéå¸¸é‡è¦çš„è¿è¡Œæœºåˆ¶â€”â€”EventLoopã€‚

ç¬¬29ç¯‡: å¦‚ä½•ç†è§£EventLoopâ€”â€”æµè§ˆå™¨ç¯‡
-------------------------

å¹²è®²ç†è®ºä¸å®¹æ˜“ç†è§£ï¼Œè®©æˆ‘ä»¬ç›´æ¥ä»¥ä¸€ä¸ªä¾‹å­å¼€å§‹å§:

    console.log('start');
    setTimeout(() => {
      console.log('timeout');
    });
    Promise.resolve().then(() => {
      console.log('resolve');
    });
    console.log('end');
    å¤åˆ¶ä»£ç 

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹:

1.  åˆšå¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ¥æ‰§è¡Œï¼Œå¯¹äºåŒæ­¥ä»£ç ç›´æ¥å‹å…¥æ‰§è¡Œæ ˆ(å…³äºæ‰§è¡Œæ ˆï¼Œè‹¥ä¸äº†è§£è¯·ç§»æ­¥ä¹‹å‰çš„æ–‡ç« ã€ŠJavaScriptå†…å­˜æœºåˆ¶ä¹‹é—®â€”â€”æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿã€‹)è¿›è¡Œæ‰§è¡Œï¼Œå› æ­¤**å…ˆæ‰“å°startå’Œend**
2.  setTimeout ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—
3.  Promise.thenä½œä¸ºä¸€ä¸ªä¸ºå¾®ä»»åŠ¡æ”¾å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—
4.  å½“æœ¬æ¬¡å®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°ä¸€ä¸ªPromise.then, **æ‰§è¡Œ**
5.  æ¥ä¸‹æ¥è¿›å…¥åˆ°ä¸‹ä¸€ä¸ªå®ä»»åŠ¡â€”â€”setTimeout, **æ‰§è¡Œ**

å› æ­¤æœ€åçš„é¡ºåºæ˜¯:

    start
    end
    resolve
    timeout
    å¤åˆ¶ä»£ç 

è¿™æ ·å°±å¸¦å¤§å®¶ç›´è§‚åœ°æ„Ÿå—åˆ°äº†æµè§ˆå™¨ç¯å¢ƒä¸‹ EventLoop çš„æ‰§è¡Œæµç¨‹ã€‚ä¸è¿‡ï¼Œè¿™åªæ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åšä¸€ä¸ªæ›´å®Œæ•´çš„æ€»ç»“ã€‚

1.  ä¸€å¼€å§‹æ•´æ®µè„šæœ¬ä½œä¸ºç¬¬ä¸€ä¸ª**å®ä»»åŠ¡**æ‰§è¡Œ
2.  æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»£ç ç›´æ¥æ‰§è¡Œï¼Œ**å®ä»»åŠ¡**è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ**å¾®ä»»åŠ¡**è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
3.  å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œå‡ºé˜Ÿï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰åˆ™ä¾æ¬¡æ‰§è¡Œï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º
4.  æ‰§è¡Œæµè§ˆå™¨ UI çº¿ç¨‹çš„æ¸²æŸ“å·¥ä½œ
5.  æ£€æŸ¥æ˜¯å¦æœ‰Web workerä»»åŠ¡ï¼Œæœ‰åˆ™æ‰§è¡Œ
6.  æ‰§è¡Œé˜Ÿé¦–æ–°çš„å®ä»»åŠ¡ï¼Œå›åˆ°2ï¼Œä¾æ­¤å¾ªç¯ï¼Œç›´åˆ°å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©º

æœ€åç»™å¤§å®¶ç•™ä¸€é“é¢˜ç›®ç»ƒä¹ :

    Promise.resolve().then(()=>{
      console.log('Promise1')  
      setTimeout(()=>{
        console.log('setTimeout2')
      },0)
    });
    setTimeout(()=>{
      console.log('setTimeout1')
      Promise.resolve().then(()=>{
        console.log('Promise2')    
      })
    },0);
    console.log('start');
    
    // start
    // Promise1
    // setTimeout1
    // Promise2
    // setTimeout2
    å¤åˆ¶ä»£ç 

ç¬¬30ç¯‡: å¦‚ä½•ç†è§£EventLoopâ€”â€”nodejsç¯‡
----------------------------

nodejs å’Œ æµè§ˆå™¨çš„ eventLoop è¿˜æ˜¯æœ‰å¾ˆå¤§å·®åˆ«çš„ï¼Œå€¼å¾—å•ç‹¬æ‹¿å‡ºæ¥è¯´ä¸€è¯´ã€‚

ä¸çŸ¥ä½ æ˜¯å¦çœ‹è¿‡å…³äº nodejs ä¸­ eventLoop çš„ä¸€äº›æ–‡ç« , æ˜¯å¦è¢«è¿™äº›æµç¨‹å›¾æå¾—çœ¼èŠ±ç¼­ä¹±ã€ä¸€å¤´é›¾æ°´:

çœ‹åˆ°è¿™ä½ ä¸ç”¨ç´§å¼ ï¼Œè¿™é‡Œä¼šæŠ›å¼€è¿™äº›æ™¦æ¶©çš„æµç¨‹å›¾ï¼Œä»¥æœ€æ¸…æ™°æµ…æ˜¾çš„æ–¹å¼æ¥ä¸€æ­¥æ­¥æ‹†è§£ nodejs çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚

### 1\. ä¸‰å¤§å…³é”®é˜¶æ®µ

é¦–å…ˆï¼Œæ¢³ç†ä¸€ä¸‹ nodejs ä¸‰ä¸ªéå¸¸é‡è¦çš„æ‰§è¡Œé˜¶æ®µ:

1.  æ‰§è¡Œ `å®šæ—¶å™¨å›è°ƒ` çš„é˜¶æ®µã€‚æ£€æŸ¥å®šæ—¶å™¨ï¼Œå¦‚æœåˆ°äº†æ—¶é—´ï¼Œå°±æ‰§è¡Œå›è°ƒã€‚è¿™äº›å®šæ—¶å™¨å°±æ˜¯setTimeoutã€setIntervalã€‚è¿™ä¸ªé˜¶æ®µæš‚ä¸”å«å®ƒ`timer`ã€‚
    
2.  è½®è¯¢(è‹±æ–‡å«`poll`)é˜¶æ®µã€‚å› ä¸ºåœ¨nodeä»£ç ä¸­éš¾å…ä¼šæœ‰å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶I/Oï¼Œç½‘ç»œI/Oç­‰ç­‰ï¼Œé‚£ä¹ˆå½“è¿™äº›å¼‚æ­¥æ“ä½œåšå®Œäº†ï¼Œå°±ä¼šæ¥é€šçŸ¥JSä¸»çº¿ç¨‹ï¼Œæ€ä¹ˆé€šçŸ¥å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡'data'ã€ 'connect'ç­‰äº‹ä»¶ä½¿å¾—äº‹ä»¶å¾ªç¯åˆ°è¾¾ `poll` é˜¶æ®µã€‚åˆ°è¾¾äº†è¿™ä¸ªé˜¶æ®µå:
    

å¦‚æœå½“å‰å·²ç»å­˜åœ¨å®šæ—¶å™¨ï¼Œè€Œä¸”æœ‰å®šæ—¶å™¨åˆ°æ—¶é—´äº†ï¼Œæ‹¿å‡ºæ¥æ‰§è¡Œï¼ŒeventLoop å°†å›åˆ°timeré˜¶æ®µã€‚

å¦‚æœæ²¡æœ‰å®šæ—¶å™¨, ä¼šå»çœ‹å›è°ƒå‡½æ•°é˜Ÿåˆ—ã€‚

*   å¦‚æœé˜Ÿåˆ—`ä¸ä¸ºç©º`ï¼Œæ‹¿å‡ºé˜Ÿåˆ—ä¸­çš„æ–¹æ³•ä¾æ¬¡æ‰§è¡Œ
*   å¦‚æœé˜Ÿåˆ—`ä¸ºç©º`ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ `setImmdiate` çš„å›è°ƒ
    *   æœ‰åˆ™å‰å¾€`checké˜¶æ®µ`(ä¸‹é¢ä¼šè¯´)
    *   `æ²¡æœ‰åˆ™ç»§ç»­ç­‰å¾…`ï¼Œç›¸å½“äºé˜»å¡äº†ä¸€æ®µæ—¶é—´(é˜»å¡æ—¶é—´æ˜¯æœ‰ä¸Šé™çš„), ç­‰å¾… callback å‡½æ•°åŠ å…¥é˜Ÿåˆ—ï¼ŒåŠ å…¥åä¼šç«‹åˆ»æ‰§è¡Œã€‚ä¸€æ®µæ—¶é—´å`è‡ªåŠ¨è¿›å…¥ check é˜¶æ®µ`ã€‚

3.  check é˜¶æ®µã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„é˜¶æ®µï¼Œç›´æ¥`æ‰§è¡Œ setImmdiate` çš„å›è°ƒã€‚

è¿™ä¸‰ä¸ªé˜¶æ®µä¸ºä¸€ä¸ªå¾ªç¯è¿‡ç¨‹ã€‚ä¸è¿‡ç°åœ¨çš„eventLoopå¹¶ä¸å®Œæ•´ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥ä¸€ä¸€åœ°å®Œå–„ã€‚

### 2\. å®Œå–„

é¦–å…ˆï¼Œå½“ç¬¬ 1 é˜¶æ®µç»“æŸåï¼Œå¯èƒ½å¹¶ä¸ä¼šç«‹å³ç­‰å¾…åˆ°å¼‚æ­¥äº‹ä»¶çš„å“åº”ï¼Œè¿™æ—¶å€™ nodejs ä¼šè¿›å…¥åˆ° `I/Oå¼‚å¸¸çš„å›è°ƒé˜¶æ®µ`ã€‚æ¯”å¦‚è¯´ TCP è¿æ¥é‡åˆ°ECONNREFUSEDï¼Œå°±ä¼šåœ¨è¿™ä¸ªæ—¶å€™æ‰§è¡Œå›è°ƒã€‚

å¹¶ä¸”åœ¨ check é˜¶æ®µç»“æŸåè¿˜ä¼šè¿›å…¥åˆ° `å…³é—­äº‹ä»¶çš„å›è°ƒé˜¶æ®µ`ã€‚å¦‚æœä¸€ä¸ª socket æˆ–å¥æŸ„ï¼ˆhandleï¼‰è¢«çªç„¶å…³é—­ï¼Œä¾‹å¦‚ socket.destroy()ï¼Œ 'close' äº‹ä»¶çš„å›è°ƒå°±ä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œã€‚

æ¢³ç†ä¸€ä¸‹ï¼Œnodejs çš„ eventLoop åˆ†ä¸ºä¸‹é¢çš„å‡ ä¸ªé˜¶æ®µ:

1.  timer é˜¶æ®µ
2.  I/O å¼‚å¸¸å›è°ƒé˜¶æ®µ
3.  ç©ºé—²ã€é¢„å¤‡çŠ¶æ€(ç¬¬2é˜¶æ®µç»“æŸï¼Œpoll æœªè§¦å‘ä¹‹å‰)
4.  poll é˜¶æ®µ
5.  check é˜¶æ®µ
6.  å…³é—­äº‹ä»¶çš„å›è°ƒé˜¶æ®µ

æ˜¯ä¸æ˜¯æ¸…æ™°äº†è®¸å¤šï¼Ÿ

### 3\. å®ä¾‹æ¼”ç¤º

å¥½ï¼Œæˆ‘ä»¬ä»¥ä¸Šæ¬¡çš„ç»ƒä¹ é¢˜æ¥å®è·µä¸€æŠŠ:

    setTimeout(()=>{
        console.log('timer1')
        Promise.resolve().then(function() {
            console.log('promise1')
        })
    }, 0)
    setTimeout(()=>{
        console.log('timer2')
        Promise.resolve().then(function() {
            console.log('promise2')
        })
    }, 0)
    å¤åˆ¶ä»£ç 

è¿™é‡Œæˆ‘è¦è¯´ï¼Œnodeç‰ˆæœ¬ >= 11å’Œåœ¨ 11 ä»¥ä¸‹çš„ä¼šæœ‰ä¸åŒçš„è¡¨ç°ã€‚

é¦–å…ˆè¯´ node ç‰ˆæœ¬ >= 11çš„ï¼Œå®ƒä¼šå’Œæµè§ˆå™¨è¡¨ç°ä¸€è‡´ï¼Œä¸€ä¸ªå®šæ—¶å™¨è¿è¡Œå®Œç«‹å³è¿è¡Œç›¸åº”çš„å¾®ä»»åŠ¡ã€‚

    timer1
    promise1
    time2
    promise2
    å¤åˆ¶ä»£ç 

è€Œ node ç‰ˆæœ¬å°äº 11 çš„æƒ…å†µä¸‹ï¼Œå¯¹äºå®šæ—¶å™¨çš„å¤„ç†æ˜¯:

> è‹¥ç¬¬ä¸€ä¸ªå®šæ—¶å™¨ä»»åŠ¡å‡ºé˜Ÿå¹¶æ‰§è¡Œå®Œï¼Œå‘ç°é˜Ÿé¦–çš„ä»»åŠ¡ä»ç„¶æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œé‚£ä¹ˆå°±å°†å¾®ä»»åŠ¡æš‚æ—¶ä¿å­˜ï¼Œ`ç›´æ¥å»æ‰§è¡Œ`æ–°çš„å®šæ—¶å™¨ä»»åŠ¡ï¼Œå½“æ–°çš„å®šæ—¶å™¨ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œ`å†ä¸€ä¸€æ‰§è¡Œ`ä¸­é€”äº§ç”Ÿçš„å¾®ä»»åŠ¡ã€‚

å› æ­¤ä¼šæ‰“å°å‡ºè¿™æ ·çš„ç»“æœ:

    timer1
    timer2
    promise1
    promise2
    å¤åˆ¶ä»£ç 

### 4.nodejs å’Œ æµè§ˆå™¨å…³äºeventLoopçš„ä¸»è¦åŒºåˆ«

ä¸¤è€…æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºæµè§ˆå™¨ä¸­çš„å¾®ä»»åŠ¡æ˜¯åœ¨`æ¯ä¸ªç›¸åº”çš„å®ä»»åŠ¡`ä¸­æ‰§è¡Œçš„ï¼Œè€Œnodejsä¸­çš„å¾®ä»»åŠ¡æ˜¯åœ¨`ä¸åŒé˜¶æ®µä¹‹é—´`æ‰§è¡Œçš„ã€‚

### 5.å…³äºprocess.nextTickçš„ä¸€ç‚¹è¯´æ˜

process.nextTick æ˜¯ä¸€ä¸ªç‹¬ç«‹äº eventLoop çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚

åœ¨æ¯ä¸€ä¸ª eventLoop é˜¶æ®µå®Œæˆåä¼šå»æ£€æŸ¥è¿™ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœé‡Œé¢æœ‰ä»»åŠ¡ï¼Œä¼šè®©è¿™éƒ¨åˆ†ä»»åŠ¡`ä¼˜å…ˆäºå¾®ä»»åŠ¡`æ‰§è¡Œã€‚

ç¬¬31ç¯‡: nodejsä¸­çš„å¼‚æ­¥ã€éé˜»å¡I/Oæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
------------------------------

åœ¨å¬åˆ° nodejs ç›¸å…³çš„ç‰¹æ€§æ—¶ï¼Œç»å¸¸ä¼šå¯¹ `å¼‚æ­¥I/O`ã€`éé˜»å¡I/O`æœ‰æ‰€è€³é—»ï¼Œå¬èµ·æ¥å¥½åƒæ˜¯å·®ä¸å¤šçš„æ„æ€ï¼Œä½†å…¶å®æ˜¯ä¸¤ç äº‹ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»¥åŸç†çš„è§’åº¦æ¥å‰–æä¸€ä¸‹å¯¹ nodejs æ¥è¯´ï¼Œè¿™ä¸¤ç§æŠ€æœ¯åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

### ä»€ä¹ˆæ˜¯I/Oï¼Ÿ

é¦–å…ˆï¼Œæˆ‘æƒ³æœ‰å¿…è¦æŠŠ I/O çš„æ¦‚å¿µè§£é‡Šä¸€ä¸‹ã€‚I/O å³Input/Output, è¾“å…¥å’Œè¾“å‡ºçš„æ„æ€ã€‚åœ¨æµè§ˆå™¨ç«¯ï¼Œåªæœ‰ä¸€ç§ I/Oï¼Œé‚£å°±æ˜¯åˆ©ç”¨ Ajax å‘é€ç½‘ç»œè¯·æ±‚ï¼Œç„¶åè¯»å–è¿”å›çš„å†…å®¹ï¼Œè¿™å±äº`ç½‘ç»œI/O`ã€‚å›åˆ° nodejs ä¸­ï¼Œå…¶å®è¿™ç§çš„ I/O çš„åœºæ™¯å°±æ›´åŠ å¹¿æ³›äº†ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§:

*   æ–‡ä»¶ I/Oã€‚æ¯”å¦‚ç”¨ fs æ¨¡å—å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œã€‚
*   ç½‘ç»œ I/Oã€‚æ¯”å¦‚ http æ¨¡å—å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚

### é˜»å¡å’Œéé˜»å¡I/O

`é˜»å¡`å’Œ`éé˜»å¡` I/O å…¶å®æ˜¯é’ˆå¯¹æ“ä½œç³»ç»Ÿå†…æ ¸è€Œè¨€çš„ï¼Œè€Œä¸æ˜¯ nodejs æœ¬èº«ã€‚é˜»å¡ I/O çš„ç‰¹ç‚¹å°±æ˜¯ä¸€å®šè¦**ç­‰åˆ°æ“ä½œç³»ç»Ÿå®Œæˆæ‰€æœ‰æ“ä½œåæ‰è¡¨ç¤ºè°ƒç”¨ç»“æŸ**ï¼Œè€Œéé˜»å¡ I/O æ˜¯è°ƒç”¨åç«‹é©¬è¿”å›ï¼Œä¸ç”¨ç­‰æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆæ“ä½œã€‚

å¯¹å‰è€…è€Œè¨€ï¼Œåœ¨æ“ä½œç³»ç»Ÿè¿›è¡Œ I/O çš„æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå…¶å®æ˜¯ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€çš„ï¼Œä»€ä¹ˆéƒ½åšä¸äº†ã€‚é‚£å¦‚æœæ¢æˆ`éé˜»å¡I/O`ï¼Œè°ƒç”¨è¿”å›åæˆ‘ä»¬çš„ nodejs åº”ç”¨ç¨‹åºå¯ä»¥å®Œæˆå…¶ä»–çš„äº‹æƒ…ï¼Œè€Œæ“ä½œç³»ç»ŸåŒæ—¶ä¹Ÿåœ¨è¿›è¡Œ I/Oã€‚è¿™æ ·å°±æŠŠç­‰å¾…çš„æ—¶é—´å……åˆ†åˆ©ç”¨äº†èµ·æ¥ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ï¼Œä½†æ˜¯åŒæ—¶åˆä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œnodejs åº”ç”¨ç¨‹åºæ€ä¹ˆçŸ¥é“æ“ä½œç³»ç»Ÿå·²ç»å®Œæˆäº† I/O æ“ä½œå‘¢ï¼Ÿ

ä¸ºäº†è®© nodejs çŸ¥é“æ“ä½œç³»ç»Ÿå·²ç»åšå®Œ I/O æ“ä½œï¼Œéœ€è¦é‡å¤åœ°å»æ“ä½œç³»ç»Ÿé‚£é‡Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å®Œæˆï¼Œè¿™ç§é‡å¤åˆ¤æ–­çš„æ–¹å¼å°±æ˜¯`è½®è¯¢`ã€‚å¯¹äºè½®è¯¢è€Œè¨€ï¼Œæœ‰ä»¥ä¸‹è¿™ä¹ˆå‡ ç§æ–¹æ¡ˆ:

1.  ä¸€ç›´è½®è¯¢æ£€æŸ¥I/OçŠ¶æ€ï¼Œç›´åˆ° I/O å®Œæˆã€‚è¿™æ˜¯æœ€åŸå§‹çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯æ€§èƒ½æœ€ä½çš„ï¼Œä¼šè®© CPU ä¸€ç›´è€—ç”¨åœ¨ç­‰å¾…ä¸Šé¢ã€‚å…¶å®è·Ÿé˜»å¡ I/O çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚
    
2.  éå†æ–‡ä»¶æè¿°ç¬¦(å³ æ–‡ä»¶I/O æ—¶æ“ä½œç³»ç»Ÿå’Œ nodejs ä¹‹é—´çš„æ–‡ä»¶å‡­è¯)çš„æ–¹å¼æ¥ç¡®å®š I/O æ˜¯å¦å®Œæˆï¼ŒI/Oå®Œæˆåˆ™æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€æ”¹å˜ã€‚ä½† CPU è½®è¯¢æ¶ˆè€—è¿˜æ˜¯å¾ˆå¤§ã€‚
    
3.  epollæ¨¡å¼ã€‚å³åœ¨è¿›å…¥è½®è¯¢çš„æ—¶å€™å¦‚æœI/Oæœªå®ŒæˆCPUå°±ä¼‘çœ ï¼Œå®Œæˆä¹‹åå”¤é†’CPUã€‚
    

æ€»ä¹‹ï¼ŒCPUè¦ä¹ˆé‡å¤æ£€æŸ¥I/Oï¼Œè¦ä¹ˆé‡å¤æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦ï¼Œè¦ä¹ˆä¼‘çœ ï¼Œéƒ½å¾—ä¸åˆ°å¾ˆå¥½çš„åˆ©ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯:

> nodejs åº”ç”¨ç¨‹åºå‘èµ· I/O è°ƒç”¨åå¯ä»¥ç›´æ¥å»æ‰§è¡Œåˆ«çš„é€»è¾‘ï¼Œæ“ä½œç³»ç»Ÿé»˜é»˜åœ°åšå®Œ I/O ä¹‹åç»™ nodejs å‘ä¸€ä¸ªå®Œæˆä¿¡å·ï¼Œnodejs æ‰§è¡Œå›è°ƒæ“ä½œã€‚

è¿™æ˜¯ç†æƒ³çš„æƒ…å†µï¼Œä¹Ÿæ˜¯å¼‚æ­¥ I/O çš„æ•ˆæœï¼Œé‚£å¦‚ä½•å®ç°è¿™æ ·çš„æ•ˆæœå‘¢ï¼Ÿ

### å¼‚æ­¥ I/O çš„æœ¬è´¨

Linux åŸç”Ÿå­˜åœ¨è¿™æ ·çš„ä¸€ç§æ–¹å¼ï¼Œå³(AIO), ä½†ä¸¤ä¸ªè‡´å‘½çš„ç¼ºé™·:

1.  åªæœ‰ Linux ä¸‹å­˜åœ¨ï¼Œåœ¨å…¶ä»–ç³»ç»Ÿä¸­æ²¡æœ‰å¼‚æ­¥ I/O æ”¯æŒã€‚
2.  æ— æ³•åˆ©ç”¨ç³»ç»Ÿç¼“å­˜ã€‚

#### nodejsä¸­çš„å¼‚æ­¥ I/O æ–¹æ¡ˆ

æ˜¯ä¸æ˜¯æ²¡æœ‰åŠæ³•äº†å‘¢ï¼Ÿåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹ç¡®å®æ˜¯è¿™æ ·ï¼Œä½†æ˜¯å¦‚æœæŠŠæ€è·¯æ”¾å¼€ä¸€ç‚¹ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå°±å˜å¾—è½»æ¾å¤šäº†ã€‚æˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œè®¡ç®—æ“ä½œï¼Œå¦å¤–ä¸€äº›è¿›è¡Œ I/O è°ƒç”¨ï¼ŒI/O å®ŒæˆåæŠŠä¿¡å·ä¼ ç»™è®¡ç®—çš„çº¿ç¨‹ï¼Œè¿›è€Œæ‰§è¡Œå›è°ƒï¼Œè¿™ä¸å°±å¥½äº†å—ï¼Ÿæ²¡é”™ï¼Œ**å¼‚æ­¥ I/O å°±æ˜¯ä½¿ç”¨è¿™æ ·çš„çº¿ç¨‹æ± æ¥å®ç°çš„**ã€‚

åªä¸è¿‡åœ¨ä¸åŒçš„ç³»ç»Ÿä¸‹é¢è¡¨ç°ä¼šæœ‰æ‰€å·®å¼‚ï¼Œåœ¨ Linux ä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨çº¿ç¨‹æ± æ¥å®Œæˆï¼Œåœ¨Windowç³»ç»Ÿä¸‹åˆ™é‡‡ç”¨ IOCP è¿™ä¸ªç³»ç»ŸAPI(å…¶å†…éƒ¨è¿˜æ˜¯ç”¨çº¿ç¨‹æ± å®Œæˆçš„)ã€‚

æœ‰äº†æ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œé‚£ nodejs å¦‚ä½•æ¥å¯¹æ¥è¿™äº›æ“ä½œç³»ç»Ÿä»è€Œå®ç°å¼‚æ­¥ I/O å‘¢ï¼Ÿ

ä»¥æ–‡ä»¶ä¸º I/O æˆ‘ä»¬ä»¥ä¸€æ®µä»£ç ä¸ºä¾‹:

    let fs = require('fs');
    
    fs.readFile('/test.txt', function (err, data) {
        console.log(data); 
    });
    å¤åˆ¶ä»£ç 

#### æ‰§è¡Œæµç¨‹

æ‰§è¡Œä»£ç çš„è¿‡ç¨‹ä¸­å¤§æ¦‚å‘ç”Ÿäº†è¿™äº›äº‹æƒ…:

1.  é¦–å…ˆï¼Œfs.readFileè°ƒç”¨Nodeçš„æ ¸å¿ƒæ¨¡å—fs.js ï¼›
2.  æ¥ä¸‹æ¥ï¼ŒNodeçš„æ ¸å¿ƒæ¨¡å—è°ƒç”¨å†…å»ºæ¨¡å—node\_file.ccï¼Œåˆ›å»ºå¯¹åº”çš„æ–‡ä»¶I/Oè§‚å¯Ÿè€…å¯¹è±¡(è¿™ä¸ªå¯¹è±¡åé¢æœ‰å¤§ç”¨ï¼) ï¼›
3.  æœ€åï¼Œæ ¹æ®ä¸åŒå¹³å°ï¼ˆLinuxæˆ–è€…windowï¼‰ï¼Œå†…å»ºæ¨¡å—é€šè¿‡libuvä¸­é—´å±‚è¿›è¡Œç³»ç»Ÿè°ƒç”¨

#### libuvè°ƒç”¨è¿‡ç¨‹æ‹†è§£

é‡ç‚¹æ¥äº†ï¼libuv ä¸­æ˜¯å¦‚ä½•æ¥è¿›è¡Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„å‘¢ï¼Ÿä¹Ÿå°±æ˜¯ uv\_fs\_open() ä¸­åšäº†äº›ä»€ä¹ˆï¼Ÿ

##### 1\. åˆ›å»ºè¯·æ±‚å¯¹è±¡

ä»¥Windowsç³»ç»Ÿä¸ºä¾‹æ¥è¯´ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶I/Oçš„**è¯·æ±‚å¯¹è±¡**ï¼Œå¹¶å¾€é‡Œé¢æ³¨å…¥äº†å›è°ƒå‡½æ•°ã€‚

    req_wrap->object_->Set(oncomplete_sym, callback);
    å¤åˆ¶ä»£ç 

req\_wrap ä¾¿æ˜¯è¿™ä¸ªè¯·æ±‚å¯¹è±¡ï¼Œreq\_wrap ä¸­ object\_ çš„ oncomplete\_sym å±æ€§å¯¹åº”çš„å€¼ä¾¿æ˜¯æˆ‘ä»¬ nodejs åº”ç”¨ç¨‹åºä»£ç ä¸­ä¼ å…¥çš„å›è°ƒå‡½æ•°ã€‚

##### 2\. æ¨å…¥çº¿ç¨‹æ± ï¼Œè°ƒç”¨è¿”å›

åœ¨è¿™ä¸ªå¯¹è±¡åŒ…è£…å®Œæˆåï¼ŒQueueUserWorkItem() æ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡æ¨è¿›çº¿ç¨‹æ± ä¸­ç­‰å¾…æ‰§è¡Œã€‚

å¥½ï¼Œè‡³æ­¤ç°åœ¨jsçš„è°ƒç”¨å°±ç›´æ¥è¿”å›äº†ï¼Œæˆ‘ä»¬çš„ js åº”ç”¨ç¨‹åºä»£ç å¯ä»¥`ç»§ç»­å¾€ä¸‹æ‰§è¡Œ`ï¼Œå½“ç„¶ï¼Œå½“å‰çš„ `I/O` æ“ä½œåŒæ—¶ä¹Ÿåœ¨çº¿ç¨‹æ± ä¸­å°†è¢«æ‰§è¡Œï¼Œè¿™ä¸å°±å®Œæˆäº†å¼‚æ­¥ä¹ˆï¼šï¼‰

ç­‰ç­‰ï¼Œåˆ«é«˜å…´å¤ªæ—©ï¼Œå›è°ƒéƒ½è¿˜æ²¡æ‰§è¡Œå‘¢ï¼æ¥ä¸‹æ¥ä¾¿æ˜¯æ‰§è¡Œå›è°ƒé€šçŸ¥çš„ç¯èŠ‚ã€‚

##### 3\. å›è°ƒé€šçŸ¥

äº‹å®ä¸Šç°åœ¨çº¿ç¨‹æ± ä¸­çš„ I/O æ— è®ºæ˜¯é˜»å¡è¿˜æ˜¯éé˜»å¡éƒ½å·²ç»æ— æ‰€è°“äº†ï¼Œå› ä¸ºå¼‚æ­¥çš„ç›®çš„å·²ç»è¾¾æˆã€‚é‡è¦çš„æ˜¯ I/O å®Œæˆåä¼šå‘ç”Ÿä»€ä¹ˆã€‚

åœ¨ä»‹ç»åç»­çš„æ•…äº‹ä¹‹å‰ï¼Œç»™å¤§å®¶ä»‹ç»ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•: `GetQueuedCompletionStatus` å’Œ `PostQueuedCompletionStatus`ã€‚

1.  è¿˜è®°å¾—ä¹‹å‰è®²è¿‡çš„ eventLoop å—ï¼Ÿåœ¨æ¯ä¸€ä¸ªTickå½“ä¸­ä¼šè°ƒç”¨`GetQueuedCompletionStatus`æ£€æŸ¥çº¿ç¨‹æ± ä¸­æ˜¯å¦æœ‰æ‰§è¡Œå®Œçš„è¯·æ±‚ï¼Œå¦‚æœæœ‰åˆ™è¡¨ç¤ºæ—¶æœºå·²ç»æˆç†Ÿï¼Œå¯ä»¥æ‰§è¡Œå›è°ƒäº†ã€‚
    
2.  `PostQueuedCompletionStatus`æ–¹æ³•åˆ™æ˜¯å‘ IOCP æäº¤çŠ¶æ€ï¼Œå‘Šè¯‰å®ƒå½“å‰I/Oå®Œæˆäº†ã€‚
    

åå­—æ¯”è¾ƒé•¿ï¼Œå…ˆä»‹ç»æ˜¯ä¸ºäº†è®©å¤§å®¶æ··ä¸ªè„¸ç†Ÿï¼Œè‡³å°‘åé¢å‡ºæ¥ä¸ä¼šæ„Ÿåˆ°å¤ªçªå…€ï¼šï¼‰

æˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼ŒæŠŠåé¢çš„è¿‡ç¨‹ä¸²è”èµ·æ¥ã€‚

å½“å¯¹åº”çº¿ç¨‹ä¸­çš„ I/O å®Œæˆåï¼Œä¼šå°†è·å¾—çš„ç»“æœ`å­˜å‚¨`èµ·æ¥ï¼Œä¿å­˜åˆ°`ç›¸åº”çš„è¯·æ±‚å¯¹è±¡`ä¸­ï¼Œç„¶åè°ƒç”¨`PostQueuedCompletionStatus()`å‘ IOCP æäº¤æ‰§è¡Œå®Œæˆçš„çŠ¶æ€ï¼Œå¹¶ä¸”å°†çº¿ç¨‹è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚ä¸€æ—¦ EventLoop çš„è½®è¯¢æ“ä½œä¸­ï¼Œè°ƒç”¨`GetQueuedCompletionStatus`æ£€æµ‹åˆ°äº†å®Œæˆçš„çŠ¶æ€ï¼Œå°±ä¼šæŠŠ`è¯·æ±‚å¯¹è±¡`å¡ç»™I/Oè§‚å¯Ÿè€…(ä¹‹å‰åŸ‹ä¸‹ä¼ç¬”ï¼Œå¦‚ä»Šç»ˆäºé—ªäº®ç™»åœº)ã€‚

I/O è§‚å¯Ÿè€…ç°åœ¨çš„è¡Œä¸ºå°±æ˜¯å–å‡º`è¯·æ±‚å¯¹è±¡`çš„`å­˜å‚¨ç»“æœ`ï¼ŒåŒæ—¶ä¹Ÿå–å‡ºå®ƒçš„`oncomplete_sym`å±æ€§ï¼Œå³å›è°ƒå‡½æ•°(ä¸æ‡‚è¿™ä¸ªå±æ€§çš„å›çœ‹ç¬¬1æ­¥çš„æ“ä½œ)ã€‚å°†å‰è€…ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥åè€…ï¼Œå¹¶æ‰§è¡Œåè€…ã€‚ è¿™é‡Œï¼Œå›è°ƒå‡½æ•°å°±æˆåŠŸæ‰§è¡Œå•¦ï¼

æ€»ç»“ :

1.  `é˜»å¡`å’Œ`éé˜»å¡` I/O å…¶å®æ˜¯é’ˆå¯¹æ“ä½œç³»ç»Ÿå†…æ ¸è€Œè¨€çš„ã€‚é˜»å¡ I/O çš„ç‰¹ç‚¹å°±æ˜¯ä¸€å®šè¦**ç­‰åˆ°æ“ä½œç³»ç»Ÿå®Œæˆæ‰€æœ‰æ“ä½œåæ‰è¡¨ç¤ºè°ƒç”¨ç»“æŸ**ï¼Œè€Œéé˜»å¡ I/O æ˜¯è°ƒç”¨åç«‹é©¬è¿”å›ï¼Œä¸ç”¨ç­‰æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆæ“ä½œã€‚
2.  nodejsä¸­çš„å¼‚æ­¥ I/O é‡‡ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œç”± `EventLoop`ã€`I/O è§‚å¯Ÿè€…`ï¼Œ`è¯·æ±‚å¯¹è±¡`ã€`çº¿ç¨‹æ± `å››å¤§è¦ç´ ç›¸äº’é…åˆï¼Œå…±åŒå®ç°ã€‚

ç¬¬32ç¯‡ï¼šJSå¼‚æ­¥ç¼–ç¨‹æœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™äº›æ–¹æ¡ˆï¼Ÿ
----------------------------

å…³äº JS `å•çº¿ç¨‹`ã€`EventLoop` ä»¥åŠ`å¼‚æ­¥ I/O` è¿™äº›åº•å±‚çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¹‹å‰åšè¿‡äº†è¯¦ç»†çš„æ‹†è§£ï¼Œä¸åœ¨èµ˜è¿°ã€‚åœ¨æ¢ç©¶äº†åº•å±‚æœºåˆ¶ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹ä»£ç çš„ç»„ç»‡æ–¹å¼æœ‰æ‰€ç†è§£ï¼Œè¿™æ˜¯ç¦»æˆ‘ä»¬æœ€æ—¥å¸¸å¼€å‘æœ€æ¥è¿‘çš„éƒ¨åˆ†ï¼Œå¼‚æ­¥ä»£ç çš„ç»„ç»‡æ–¹å¼ç›´æ¥å†³å®šäº†`å¼€å‘`å’Œ`ç»´æŠ¤`çš„`æ•ˆç‡`ï¼Œå…¶é‡è¦æ€§ä¹Ÿä¸å¯å°è§‘ã€‚å°½ç®¡**åº•å±‚æœºåˆ¶**æ²¡å˜ï¼Œä½†å¼‚æ­¥ä»£ç çš„ç»„ç»‡æ–¹å¼å´éšç€ ES æ ‡å‡†çš„å‘å±•ï¼Œä¸€æ­¥æ­¥å‘ç”Ÿäº†å·¨å¤§çš„`å˜é©`ã€‚æ¥ç€è®©æˆ‘ä»¬æ¥ä¸€æ¢ç©¶ç«Ÿå§ï¼

### å›è°ƒå‡½æ•°æ—¶ä»£

ç›¸ä¿¡å¾ˆå¤š nodejs çš„åˆå­¦è€…éƒ½æˆ–å¤šæˆ–å°‘è¸©è¿‡è¿™æ ·çš„å‘ï¼Œnode ä¸­å¾ˆå¤šåŸç”Ÿçš„ api å°±æ˜¯è¯¸å¦‚è¿™æ ·çš„:

    fs.readFile('xxx', (err, data) => {
    
    });
    å¤åˆ¶ä»£ç 

å…¸å‹çš„é«˜é˜¶å‡½æ•°ï¼Œå°†å›è°ƒå‡½æ•°ä½œä¸ºå‡½æ•°å‚æ•°ä¼ ç»™äº†readFileã€‚ä½†ä¹…è€Œä¹…ä¹‹ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™ç§ä¼ å…¥å›è°ƒçš„æ–¹å¼ä¹Ÿå­˜åœ¨å¤§å‘, æ¯”å¦‚ä¸‹é¢è¿™æ ·:

    fs.readFile('1.json', (err, data) => {
        fs.readFile('2.json', (err, data) => {
            fs.readFile('3.json', (err, data) => {
                fs.readFile('4.json', (err, data) => {
    
                });
            });
        });
    });
    å¤åˆ¶ä»£ç 

å›è°ƒå½“ä¸­åµŒå¥—å›è°ƒï¼Œä¹Ÿç§°`å›è°ƒåœ°ç‹±`ã€‚è¿™ç§ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½æ˜¯éå¸¸å·®çš„ï¼Œå› ä¸ºåµŒå¥—çš„å±‚çº§å¤ªå¤šã€‚è€Œä¸”è¿˜æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡ä»»åŠ¡å¯èƒ½ä¼šå¤±è´¥ï¼Œéœ€è¦åœ¨å›è°ƒé‡Œé¢å¯¹æ¯ä¸ªä»»åŠ¡çš„å¤±è´¥æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œå¢åŠ äº†ä»£ç çš„æ··ä¹±ç¨‹åº¦ã€‚

### Promise æ—¶ä»£

ES6 ä¸­æ–°å¢çš„ Promise å°±å¾ˆå¥½äº†è§£å†³äº†`å›è°ƒåœ°ç‹±`çš„é—®é¢˜ï¼ŒåŒæ—¶äº†åˆå¹¶äº†é”™è¯¯å¤„ç†ã€‚å†™å‡ºæ¥çš„ä»£ç ç±»ä¼¼äºä¸‹é¢è¿™æ ·:

    readFilePromise('1.json').then(data => {
        return readFilePromise('2.json')
    }).then(data => {
        return readFilePromise('3.json')
    }).then(data => {
        return readFilePromise('4.json')
    });
    å¤åˆ¶ä»£ç 

ä»¥é“¾å¼è°ƒç”¨çš„æ–¹å¼é¿å…äº†å¤§é‡çš„åµŒå¥—ï¼Œä¹Ÿç¬¦åˆäººçš„çº¿æ€§æ€ç»´æ–¹å¼ï¼Œå¤§å¤§æ–¹ä¾¿äº†å¼‚æ­¥ç¼–ç¨‹ã€‚

### co + Generator æ–¹å¼

åˆ©ç”¨åç¨‹å®Œæˆ Generator å‡½æ•°ï¼Œç”¨ co åº“è®©ä»£ç ä¾æ¬¡æ‰§è¡Œå®Œï¼ŒåŒæ—¶ä»¥åŒæ­¥çš„æ–¹å¼ä¹¦å†™ï¼Œä¹Ÿè®©å¼‚æ­¥æ“ä½œæŒ‰é¡ºåºæ‰§è¡Œã€‚

    co(function* () {
      const r1 = yield readFilePromise('1.json');
      const r2 = yield readFilePromise('2.json');
      const r3 = yield readFilePromise('3.json');
      const r4 = yield readFilePromise('4.json');
    })
    å¤åˆ¶ä»£ç 

### async + awaitæ–¹å¼

è¿™æ˜¯ ES7 ä¸­æ–°å¢çš„å…³é”®å­—ï¼Œå‡¡æ˜¯åŠ ä¸Š async çš„å‡½æ•°éƒ½é»˜è®¤è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œæ›´é‡è¦çš„æ˜¯ async + await ä¹Ÿèƒ½è®©å¼‚æ­¥ä»£ç ä»¥åŒæ­¥çš„æ–¹å¼æ¥ä¹¦å†™ï¼Œè€Œä¸éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“çš„æ”¯æŒã€‚

    const readFileAsync = async function () {
      const f1 = await readFilePromise('1.json')
      const f2 = await readFilePromise('2.json')
      const f3 = await readFilePromise('3.json')
      const f4 = await readFilePromise('4.json')
    }
    å¤åˆ¶ä»£ç 

è¿™å››ç§ç»å…¸çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼å°±ç®€å•å›é¡¾å®Œäº†ï¼Œç”±äºæ˜¯é¸Ÿç°å¤§å±€ï¼Œæˆ‘è§‰å¾—`çŸ¥é“æ˜¯ä»€ä¹ˆ`æ¯”`äº†è§£ç»†èŠ‚`è¦é‡è¦, å› æ­¤ä¹Ÿæ²¡æœ‰å±•å¼€ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é’ˆå¯¹è¿™äº›å…·ä½“çš„è§£å†³æ–¹æ¡ˆï¼Œä¸€æ­¥æ­¥æ·±å…¥å¼‚æ­¥ç¼–ç¨‹ï¼Œç†è§£å…¶ä¸­çš„æœ¬è´¨ã€‚

ç¬¬33ç¯‡: èƒ½ä¸èƒ½ç®€å•å®ç°ä¸€ä¸‹ node ä¸­å›è°ƒå‡½æ•°çš„æœºåˆ¶ï¼Ÿ
------------------------------

`å›è°ƒå‡½æ•°`çš„æ–¹å¼å…¶å®å†…éƒ¨åˆ©ç”¨äº†`å‘å¸ƒ-è®¢é˜…`æ¨¡å¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä»¥æ¨¡æ‹Ÿå®ç° node ä¸­çš„ Event æ¨¡å—ä¸ºä¾‹æ¥å†™å®ç°å›è°ƒå‡½æ•°çš„æœºåˆ¶ã€‚

    function EventEmitter() {
      this.events = new Map();
    }
    å¤åˆ¶ä»£ç 

è¿™ä¸ª EventEmitter ä¸€å…±éœ€è¦å®ç°è¿™äº›æ–¹æ³•: `addListener`, `removeListener`, `once`, `removeAllListener`, `emit`ã€‚

é¦–å…ˆæ˜¯addListenerï¼š

    // once å‚æ•°è¡¨ç¤ºæ˜¯å¦åªæ˜¯è§¦å‘ä¸€æ¬¡
    const wrapCallback = (fn, once = false) => ({ callback: fn, once });
    
    EventEmitter.prototype.addListener = function (type, fn, once = false) {
      let handler = this.events.get(type);
      if (!handler) {
        // ä¸º type äº‹ä»¶ç»‘å®šå›è°ƒ
        this.events.set(type, wrapCallback(fn, once));
      } else if (handler && typeof handler.callback === 'function') {
        // ç›®å‰ type äº‹ä»¶åªæœ‰ä¸€ä¸ªå›è°ƒ
        this.events.set(type, [handler, wrapCallback(fn, once)]);
      } else {
        // ç›®å‰ type äº‹ä»¶å›è°ƒæ•° >= 2
        handler.push(wrapCallback(fn, once));
      }
    }
    å¤åˆ¶ä»£ç 

removeLisener çš„å®ç°å¦‚ä¸‹:

    EventEmitter.prototype.removeListener = function (type, listener) {
      let handler = this.events.get(type);
      if (!handler) return;
      if (!Array.isArray(handler)) {
        if (handler.callback === listener.callback) this.events.delete(type);
        else return;
      }
      for (let i = 0; i < handler.length; i++) {
        let item = handler[i];
        if (item.callback === listener.callback) {
          // åˆ é™¤è¯¥å›è°ƒï¼Œæ³¨æ„æ•°ç»„å¡Œé™·çš„é—®é¢˜ï¼Œå³åé¢çš„å…ƒç´ ä¼šå¾€å‰æŒªä¸€ä½ã€‚i è¦ -- 
          handler.splice(i, 1);
          i--;
          if (handler.length === 1) {
            // é•¿åº¦ä¸º 1 å°±ä¸ç”¨æ•°ç»„å­˜äº†
            this.events.set(type, handler[0]);
          }
        }
      }
    }
    å¤åˆ¶ä»£ç 

once å®ç°æ€è·¯å¾ˆç®€å•ï¼Œå…ˆè°ƒç”¨ addListener æ·»åŠ ä¸Šäº†onceæ ‡è®°çš„å›è°ƒå¯¹è±¡, ç„¶ååœ¨ emit çš„æ—¶å€™éå†å›è°ƒåˆ—è¡¨ï¼Œå°†æ ‡è®°äº†once: trueçš„é¡¹removeæ‰å³å¯ã€‚

    EventEmitter.prototype.once = function (type, fn) {
      this.addListener(type, fn, true);
    }
    
    EventEmitter.prototype.emit = function (type, ...args) {
      let handler = this.events.get(type);
      if (!handler) return;
      if (Array.isArray(handler)) {
        // éå†åˆ—è¡¨ï¼Œæ‰§è¡Œå›è°ƒ
        handler.map(item => {
          item.callback.apply(this, args);
          // æ ‡è®°çš„ once: true çš„é¡¹ç›´æ¥ç§»é™¤
          if (item.once) this.removeListener(type, item);
        })
      } else {
        // åªæœ‰ä¸€ä¸ªå›è°ƒåˆ™ç›´æ¥æ‰§è¡Œ
        handler.callback.apply(this, args);
      }
      return true;
    }
    
    å¤åˆ¶ä»£ç 

æœ€åæ˜¯ removeAllListenerï¼š

    EventEmitter.prototype.removeAllListener = function (type) {
      let handler = this.events.get(type);
      if (!handler) return;
      else this.events.delete(type);
    }
    å¤åˆ¶ä»£ç 

ç°åœ¨æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹:

    let e = new EventEmitter();
    e.addListener('type', () => {
      console.log("typeäº‹ä»¶è§¦å‘ï¼");
    })
    e.addListener('type', () => {
      console.log("WOW!typeäº‹ä»¶åˆè§¦å‘äº†ï¼");
    })
    
    function f() { 
      console.log("typeäº‹ä»¶æˆ‘åªè§¦å‘ä¸€æ¬¡"); 
    }
    e.once('type', f)
    e.emit('type');
    e.emit('type');
    e.removeAllListener('type');
    e.emit('type');
    
    // typeäº‹ä»¶è§¦å‘ï¼
    // WOW!typeäº‹ä»¶åˆè§¦å‘äº†ï¼
    // typeäº‹ä»¶æˆ‘åªè§¦å‘ä¸€æ¬¡
    // typeäº‹ä»¶è§¦å‘ï¼
    // WOW!typeäº‹ä»¶åˆè§¦å‘äº†ï¼
    å¤åˆ¶ä»£ç 

OKï¼Œä¸€ä¸ªç®€æ˜“çš„ Event å°±è¿™æ ·å®ç°å®Œæˆäº†ï¼Œä¸ºä»€ä¹ˆè¯´å®ƒç®€æ˜“å‘¢ï¼Ÿå› ä¸ºè¿˜æœ‰å¾ˆå¤šç»†èŠ‚çš„éƒ¨åˆ†æ²¡æœ‰è€ƒè™‘:

1.  åœ¨`å‚æ•°å°‘`çš„æƒ…å†µä¸‹ï¼Œcall çš„æ€§èƒ½ä¼˜äº applyï¼Œåä¹‹ apply çš„æ€§èƒ½æ›´å¥½ã€‚å› æ­¤åœ¨æ‰§è¡Œå›è°ƒæ—¶å€™å¯ä»¥æ ¹æ®æƒ…å†µè°ƒç”¨ call æˆ–è€… applyã€‚
2.  è€ƒè™‘åˆ°å†…å­˜å®¹é‡ï¼Œåº”è¯¥è®¾ç½®`å›è°ƒåˆ—è¡¨çš„æœ€å¤§å€¼`ï¼Œå½“è¶…è¿‡æœ€å¤§å€¼çš„æ—¶å€™ï¼Œåº”è¯¥é€‰æ‹©éƒ¨åˆ†å›è°ƒè¿›è¡Œåˆ é™¤æ“ä½œã€‚
3.  `é²æ£’æ€§`æœ‰å¾…æé«˜ã€‚å¯¹äº`å‚æ•°çš„æ ¡éªŒ`å¾ˆå¤šåœ°æ–¹ç›´æ¥å¿½ç•¥æ‰äº†ã€‚

ä¸è¿‡ï¼Œè¿™ä¸ªæ¡ˆä¾‹çš„ç›®çš„åªæ˜¯å¸¦å¤§å®¶æŒæ¡æ ¸å¿ƒçš„åŸç†ï¼Œå¦‚æœåœ¨è¿™é‡Œæ´‹æ´‹æ´’æ´’å†™ä¸‰å››ç™¾è¡Œæ„ä¹‰ä¹Ÿä¸å¤§ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹çœ‹Nodeä¸­ [Event æ¨¡å—](https://github.com/Gozala/events/blob/master/events.js) çš„æºç ï¼Œé‡Œé¢å¯¹å„ç§ç»†èŠ‚å’Œè¾¹ç•Œæƒ…å†µåšäº†è¯¦ç»†çš„å¤„ç†ã€‚

ç¬¬34ç¯‡: Promiseä¹‹é—®(ä¸€)â€”â€”Promise å‡­å€Ÿä»€ä¹ˆæ¶ˆç­äº†å›è°ƒåœ°ç‹±ï¼Ÿ
----------------------------------------

### é—®é¢˜

é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å›è°ƒåœ°ç‹±:

1.  å¤šå±‚åµŒå¥—çš„é—®é¢˜ã€‚
2.  æ¯ç§ä»»åŠ¡çš„å¤„ç†ç»“æœå­˜åœ¨ä¸¤ç§å¯èƒ½æ€§ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ¯ç§ä»»åŠ¡æ‰§è¡Œç»“æŸååˆ†åˆ«å¤„ç†è¿™ä¸¤ç§å¯èƒ½æ€§ã€‚

è¿™ä¸¤ç§é—®é¢˜åœ¨å›è°ƒå‡½æ•°æ—¶ä»£å°¤ä¸ºçªå‡ºã€‚Promise çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚

### è§£å†³æ–¹æ³•

Promise åˆ©ç”¨äº†ä¸‰å¤§æŠ€æœ¯æ‰‹æ®µæ¥è§£å†³`å›è°ƒåœ°ç‹±`:

*   **å›è°ƒå‡½æ•°å»¶è¿Ÿç»‘å®š**ã€‚
*   **è¿”å›å€¼ç©¿é€**ã€‚
*   **é”™è¯¯å†’æ³¡**ã€‚

é¦–å…ˆæ¥ä¸¾ä¸ªä¾‹å­:

    let readFilePromise = (filename) => {
      fs.readFile(filename, (err, data) => {
        if(err) {
          reject(err);
        }else {
          resolve(data);
        }
      })
    }
    readFilePromise('1.json').then(data => {
      return readFilePromise('2.json')
    });
    å¤åˆ¶ä»£ç 

çœ‹åˆ°æ²¡æœ‰ï¼Œå›è°ƒå‡½æ•°ä¸æ˜¯ç›´æ¥å£°æ˜çš„ï¼Œè€Œæ˜¯åœ¨é€šè¿‡åé¢çš„ then æ–¹æ³•ä¼ å…¥çš„ï¼Œå³å»¶è¿Ÿä¼ å…¥ã€‚è¿™å°±æ˜¯`å›è°ƒå‡½æ•°å»¶è¿Ÿç»‘å®š`ã€‚

ç„¶åæˆ‘ä»¬åšä»¥ä¸‹å¾®è°ƒ:

    let x = readFilePromise('1.json').then(data => {
      return readFilePromise('2.json')//è¿™æ˜¯è¿”å›çš„Promise
    });
    x.then(/* å†…éƒ¨é€»è¾‘çœç•¥ */)
    å¤åˆ¶ä»£ç 

æˆ‘ä»¬ä¼šæ ¹æ® then ä¸­å›è°ƒå‡½æ•°çš„ä¼ å…¥å€¼åˆ›å»ºä¸åŒç±»å‹çš„Promise, ç„¶åæŠŠè¿”å›çš„ Promise ç©¿é€åˆ°å¤–å±‚, ä»¥ä¾›åç»­çš„è°ƒç”¨ã€‚è¿™é‡Œçš„ x æŒ‡çš„å°±æ˜¯å†…éƒ¨è¿”å›çš„ Promiseï¼Œç„¶ååœ¨ x åé¢å¯ä»¥ä¾æ¬¡å®Œæˆé“¾å¼è°ƒç”¨ã€‚

è¿™ä¾¿æ˜¯`è¿”å›å€¼ç©¿é€`çš„æ•ˆæœã€‚

è¿™ä¸¤ç§æŠ€æœ¯ä¸€èµ·ä½œç”¨ä¾¿å¯ä»¥å°†æ·±å±‚çš„åµŒå¥—å›è°ƒå†™æˆä¸‹é¢çš„å½¢å¼:

    readFilePromise('1.json').then(data => {
        return readFilePromise('2.json');
    }).then(data => {
        return readFilePromise('3.json');
    }).then(data => {
        return readFilePromise('4.json');
    });
    å¤åˆ¶ä»£ç 

è¿™æ ·å°±æ˜¾å¾—æ¸…çˆ½äº†è®¸å¤šï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒæ›´ç¬¦åˆäººçš„çº¿æ€§æ€ç»´æ¨¡å¼ï¼Œå¼€å‘ä½“éªŒä¹Ÿæ›´å¥½ã€‚

ä¸¤ç§æŠ€æœ¯ç»“åˆäº§ç”Ÿäº†`é“¾å¼è°ƒç”¨`çš„æ•ˆæœã€‚

è¿™è§£å†³çš„æ˜¯å¤šå±‚åµŒå¥—çš„é—®é¢˜ï¼Œé‚£å¦ä¸€ä¸ªé—®é¢˜ï¼Œå³æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œç»“æŸå`åˆ†åˆ«å¤„ç†æˆåŠŸå’Œå¤±è´¥`çš„æƒ…å†µæ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ

Promise é‡‡ç”¨äº†`é”™è¯¯å†’æ³¡`çš„æ–¹å¼ã€‚å…¶å®å¾ˆç®€å•ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœ:

    readFilePromise('1.json').then(data => {
        return readFilePromise('2.json');
    }).then(data => {
        return readFilePromise('3.json');
    }).then(data => {
        return readFilePromise('4.json');
    }).catch(err => {
      // xxx
    })
    å¤åˆ¶ä»£ç 

è¿™æ ·å‰é¢äº§ç”Ÿçš„é”™è¯¯ä¼šä¸€ç›´å‘åä¼ é€’ï¼Œè¢« catch æ¥æ”¶åˆ°ï¼Œå°±ä¸ç”¨é¢‘ç¹åœ°æ£€æŸ¥é”™è¯¯äº†ã€‚

### è§£å†³æ•ˆæœ

*   1.  å®ç°é“¾å¼è°ƒç”¨ï¼Œè§£å†³å¤šå±‚åµŒå¥—é—®é¢˜
*   2.  å®ç°é”™è¯¯å†’æ³¡åä¸€ç«™å¼å¤„ç†ï¼Œè§£å†³æ¯æ¬¡ä»»åŠ¡ä¸­åˆ¤æ–­é”™è¯¯ã€å¢åŠ ä»£ç æ··ä¹±åº¦çš„é—®é¢˜

ç¬¬35ç¯‡: Promiseä¹‹é—®(äºŒ)â€”â€”ä¸ºä»€ä¹ˆPromiseè¦å¼•å…¥å¾®ä»»åŠ¡ï¼Ÿ
-------------------------------------

åœ¨è¿™é‡Œï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰æ¥è§¦è¿‡ Promise, åŠ¡å¿…å»çœ‹çœ‹ [MDN æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)ï¼Œäº†è§£ä½¿ç”¨æ–¹å¼ï¼Œä¸ç„¶åé¢å¾ˆä¼šæ‡µã€‚

Promise ä¸­çš„æ‰§è¡Œå‡½æ•°æ˜¯åŒæ­¥è¿›è¡Œçš„ï¼Œä½†æ˜¯é‡Œé¢å­˜åœ¨ç€å¼‚æ­¥æ“ä½œï¼Œåœ¨å¼‚æ­¥æ“ä½œç»“æŸåä¼šè°ƒç”¨ resolve æ–¹æ³•ï¼Œæˆ–è€…ä¸­é€”é‡åˆ°é”™è¯¯è°ƒç”¨ reject æ–¹æ³•ï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ä½œä¸ºå¾®ä»»åŠ¡è¿›å…¥åˆ° EventLoop ä¸­ã€‚ä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼ŒPromise ä¸ºä»€ä¹ˆè¦å¼•å…¥å¾®ä»»åŠ¡çš„æ–¹å¼æ¥è¿›è¡Œå›è°ƒæ“ä½œï¼Ÿ

### è§£å†³æ–¹å¼

å›åˆ°é—®é¢˜æœ¬èº«ï¼Œå…¶å®å°±æ˜¯å¦‚ä½•å¤„ç†å›è°ƒçš„é—®é¢˜ã€‚æ€»ç»“èµ·æ¥æœ‰ä¸‰ç§æ–¹å¼:

1.  ä½¿ç”¨åŒæ­¥å›è°ƒï¼Œç›´åˆ°å¼‚æ­¥ä»»åŠ¡è¿›è¡Œå®Œï¼Œå†è¿›è¡Œåé¢çš„ä»»åŠ¡ã€‚
2.  ä½¿ç”¨å¼‚æ­¥å›è°ƒï¼Œå°†å›è°ƒå‡½æ•°æ”¾åœ¨è¿›è¡Œ`å®ä»»åŠ¡é˜Ÿåˆ—`çš„é˜Ÿå°¾ã€‚
3.  ä½¿ç”¨å¼‚æ­¥å›è°ƒï¼Œå°†å›è°ƒå‡½æ•°æ”¾åˆ°`å½“å‰å®ä»»åŠ¡ä¸­`çš„æœ€åé¢ã€‚

### ä¼˜åŠ£å¯¹æ¯”

ç¬¬ä¸€ç§æ–¹å¼æ˜¾ç„¶ä¸å¯å–ï¼Œå› ä¸ºåŒæ­¥çš„é—®é¢˜éå¸¸æ˜æ˜¾ï¼Œä¼šè®©æ•´ä¸ªè„šæœ¬é˜»å¡ä½ï¼Œå½“å‰ä»»åŠ¡ç­‰å¾…ï¼Œåé¢çš„ä»»åŠ¡éƒ½æ— æ³•å¾—åˆ°æ‰§è¡Œï¼Œè€Œè¿™éƒ¨åˆ†`ç­‰å¾…çš„æ—¶é—´`æ˜¯å¯ä»¥æ‹¿æ¥å®Œæˆå…¶ä»–äº‹æƒ…çš„ï¼Œå¯¼è‡´ CPU çš„åˆ©ç”¨ç‡éå¸¸ä½ï¼Œè€Œä¸”è¿˜æœ‰å¦å¤–ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ï¼Œå°±æ˜¯æ— æ³•å®ç°`å»¶è¿Ÿç»‘å®š`çš„æ•ˆæœã€‚

å¦‚æœé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œé‚£ä¹ˆæ‰§è¡Œå›è°ƒ(resolve/reject)çš„æ—¶æœºåº”è¯¥æ˜¯åœ¨å‰é¢`æ‰€æœ‰çš„å®ä»»åŠ¡`å®Œæˆä¹‹åï¼Œå€˜è‹¥ç°åœ¨çš„ä»»åŠ¡é˜Ÿåˆ—éå¸¸é•¿ï¼Œé‚£ä¹ˆå›è°ƒè¿Ÿè¿Ÿå¾—ä¸åˆ°æ‰§è¡Œï¼Œé€ æˆ`åº”ç”¨å¡é¡¿`ã€‚

ä¸ºäº†è§£å†³ä¸Šè¿°æ–¹æ¡ˆçš„é—®é¢˜ï¼Œå¦å¤–ä¹Ÿè€ƒè™‘åˆ°`å»¶è¿Ÿç»‘å®š`çš„éœ€æ±‚ï¼ŒPromise é‡‡å–ç¬¬ä¸‰ç§æ–¹å¼, å³`å¼•å…¥å¾®ä»»åŠ¡`, å³æŠŠ resolve(reject) å›è°ƒçš„æ‰§è¡Œæ”¾åœ¨å½“å‰å®ä»»åŠ¡çš„æœ«å°¾ã€‚

è¿™æ ·ï¼Œåˆ©ç”¨`å¾®ä»»åŠ¡`è§£å†³äº†ä¸¤å¤§ç—›ç‚¹:

*   1.  é‡‡ç”¨**å¼‚æ­¥å›è°ƒ**æ›¿ä»£åŒæ­¥å›è°ƒè§£å†³äº†æµªè´¹ CPU æ€§èƒ½çš„é—®é¢˜ã€‚
*   2.  æ”¾åˆ°**å½“å‰å®ä»»åŠ¡æœ€å**æ‰§è¡Œï¼Œè§£å†³äº†å›è°ƒæ‰§è¡Œçš„å®æ—¶æ€§é—®é¢˜ã€‚

å¥½ï¼ŒPromise çš„åŸºæœ¬å®ç°æ€æƒ³å·²ç»è®²æ¸…æ¥šäº†ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»çŸ¥é“äº†å®ƒ`ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡`ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€æ­¥æ­¥å¼„æ¸…æ¥šå®ƒå†…éƒ¨åˆ°åº•æ˜¯`æ€ä¹ˆè®¾è®¡çš„`ã€‚

ç¬¬36ç¯‡: Promiseä¹‹é—®(ä¸‰)â€”â€”Promise å¦‚ä½•å®ç°é“¾å¼è°ƒç”¨ï¼Ÿ
-------------------------------------

ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å°±æ¥åŠ¨æ‰‹å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Promiseï¼Œä¸€æ­¥æ­¥æ·±æŒ–å…¶ä¸­çš„ç»†èŠ‚ã€‚æˆ‘ä»¬å…ˆä»é“¾å¼è°ƒç”¨å¼€å§‹ã€‚

### ç®€æ˜“ç‰ˆå®ç°

é¦–å…ˆå†™å‡ºç¬¬ä¸€ç‰ˆçš„ä»£ç :

    //å®šä¹‰ä¸‰ç§çŠ¶æ€
    const PENDING = "pending";
    const FULFILLED = "fulfilled";
    const REJECTED = "rejected";
    
    function MyPromise(executor) {
      let self = this; // ç¼“å­˜å½“å‰promiseå®ä¾‹
      self.value = null;
      self.error = null; 
      self.status = PENDING;
      self.onFulfilled = null; //æˆåŠŸçš„å›è°ƒå‡½æ•°
      self.onRejected = null; //å¤±è´¥çš„å›è°ƒå‡½æ•°
    
      const resolve = (value) => {
        if(self.status !== PENDING) return;
        setTimeout(() => {
          self.status = FULFILLED;
          self.value = value;
          self.onFulfilled(self.value);//resolveæ—¶æ‰§è¡ŒæˆåŠŸå›è°ƒ
        });
      };
    
      const reject = (error) => {
        if(self.status !== PENDING) return;
        setTimeout(() => {
          self.status = REJECTED;
          self.error = error;
          self.onRejected(self.error);//resolveæ—¶æ‰§è¡ŒæˆåŠŸå›è°ƒ
        });
      };
      executor(resolve, reject);
    }
    MyPromise.prototype.then = function(onFulfilled, onRejected) {
      if (this.status === PENDING) {
        this.onFulfilled = onFulfilled;
        this.onRejected = onRejected;
      } else if (this.status === FULFILLED) {
        //å¦‚æœçŠ¶æ€æ˜¯fulfilledï¼Œç›´æ¥æ‰§è¡ŒæˆåŠŸå›è°ƒï¼Œå¹¶å°†æˆåŠŸå€¼ä¼ å…¥
        onFulfilled(this.value)
      } else {
        //å¦‚æœçŠ¶æ€æ˜¯rejectedï¼Œç›´æ¥æ‰§è¡Œå¤±è´¥å›è°ƒï¼Œå¹¶å°†å¤±è´¥åŸå› ä¼ å…¥
        onRejected(this.error)
      }
      return this;
    }
    å¤åˆ¶ä»£ç 

å¯ä»¥çœ‹åˆ°ï¼ŒPromise çš„æœ¬è´¨æ˜¯ä¸€ä¸ª`æœ‰é™çŠ¶æ€æœº`ï¼Œå­˜åœ¨ä¸‰ç§çŠ¶æ€:

*   PENDING(ç­‰å¾…)
*   FULFILLED(æˆåŠŸ)
*   REJECTED(å¤±è´¥)

çŠ¶æ€æ”¹å˜è§„åˆ™å¦‚ä¸‹å›¾:

å¯¹äº Promise è€Œè¨€ï¼ŒçŠ¶æ€çš„æ”¹å˜`ä¸å¯é€†`ï¼Œå³ç”±ç­‰å¾…æ€å˜ä¸ºå…¶ä»–çš„çŠ¶æ€åï¼Œå°±æ— æ³•å†æ”¹å˜äº†ã€‚

ä¸è¿‡ï¼Œå›åˆ°ç›®å‰è¿™ä¸€ç‰ˆçš„ Promise, è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ã€‚

### è®¾ç½®å›è°ƒæ•°ç»„

é¦–å…ˆåªèƒ½æ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¯¹äºå¤šä¸ªå›è°ƒçš„ç»‘å®šå°±æ— èƒ½ä¸ºåŠ›ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·:

    let promise1 = new MyPromise((resolve, reject) => {
      fs.readFile('./001.txt', (err, data) => {
        if(!err){
          resolve(data);
        }else {
          reject(err);
        }
      })
    });
    
    let x1 = promise1.then(data => {
      console.log("ç¬¬ä¸€æ¬¡å±•ç¤º", data.toString());    
    });
    
    let x2 = promise1.then(data => {
      console.log("ç¬¬äºŒæ¬¡å±•ç¤º", data.toString());    
    });
    
    let x3 = promise1.then(data => {
      console.log("ç¬¬ä¸‰æ¬¡å±•ç¤º", data.toString());    
    });
    å¤åˆ¶ä»£ç 

è¿™é‡Œæˆ‘ç»‘å®šäº†ä¸‰ä¸ªå›è°ƒï¼Œæƒ³è¦åœ¨ resolve() ä¹‹åä¸€èµ·æ‰§è¡Œï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ

éœ€è¦å°† `onFulfilled` å’Œ `onRejected` æ”¹ä¸ºæ•°ç»„ï¼Œè°ƒç”¨ resolve æ—¶å°†å…¶ä¸­çš„æ–¹æ³•æ‹¿å‡ºæ¥ä¸€ä¸€æ‰§è¡Œå³å¯ã€‚

    self.onFulfilledCallback = [];
    self.onRejectedCallback = [];
    å¤åˆ¶ä»£ç 

    MyPromise.prototype.then = function(onFulfilled, onRejected) {
      if (this.status === PENDING) {
        this.onFulfilledCallbacks.push(onFulfilled);
        this.onRejectedCallbacks.push(onRejected);
      } else if (this.status === FULFILLED) {
        onFulfilled(this.value);
      } else {
        onRejected(this.error);
      }
      return this;
    }
    å¤åˆ¶ä»£ç 

æ¥ä¸‹æ¥å°† resolve å’Œ reject æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒçš„éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼š

    // resolve ä¸­
    self.onFulfilledCallback.forEach((callback) => callback(self.value));
    //reject ä¸­
    self.onRejectedCallback.forEach((callback) => callback(self.error));
    å¤åˆ¶ä»£ç 

### é“¾å¼è°ƒç”¨å®Œæˆ

æˆ‘ä»¬é‡‡ç”¨ç›®å‰çš„ä»£ç æ¥è¿›è¡Œæµ‹è¯•:

    let fs = require('fs');
    let readFilePromise = (filename) => {
      return new MyPromise((resolve, reject) => {
        fs.readFile(filename, (err, data) => {
          if(!err){
            resolve(data);
          }else {
            reject(err);
          }
        })
      })
    }
    readFilePromise('./001.txt').then(data => {
      console.log(data.toString());    
      return readFilePromise('./002.txt');
    }).then(data => {
      console.log(data.toString());
    })
    // 001.txtçš„å†…å®¹
    // 001.txtçš„å†…å®¹
    å¤åˆ¶ä»£ç 

å’¦ï¼Ÿæ€ä¹ˆæ‰“å°äº†ä¸¤ä¸ª `001`ï¼Œç¬¬äºŒæ¬¡ä¸æ˜¯è¯»çš„ `002` æ–‡ä»¶å—ï¼Ÿ

é—®é¢˜å‡ºåœ¨è¿™é‡Œ:

    MyPromise.prototype.then = function(onFulfilled, onRejected) {
      //...
      return this;
    }
    å¤åˆ¶ä»£ç 

è¿™ä¹ˆå†™æ¯æ¬¡è¿”å›çš„éƒ½æ˜¯ç¬¬ä¸€ä¸ª Promiseã€‚then å‡½æ•°å½“ä¸­è¿”å›çš„ç¬¬äºŒä¸ª Promise ç›´æ¥è¢«æ— è§†äº†ï¼

è¯´æ˜ then å½“ä¸­çš„å®ç°è¿˜éœ€è¦æ”¹è¿›, æˆ‘ä»¬ç°åœ¨éœ€è¦å¯¹ then ä¸­è¿”å›å€¼é‡è§†èµ·æ¥ã€‚

    MyPromise.prototype.then = function (onFulfilled, onRejected) {
      let bridgePromise;
      let self = this;
      if (self.status === PENDING) {
        return bridgePromise = new MyPromise((resolve, reject) => {
          self.onFulfilledCallbacks.push((value) => {
            try {
              // çœ‹åˆ°äº†å—ï¼Ÿè¦æ‹¿åˆ° then ä¸­å›è°ƒè¿”å›çš„ç»“æœã€‚
              let x = onFulfilled(value);
              resolve(x);
            } catch (e) {
              reject(e);
            }
          });
          self.onRejectedCallbacks.push((error) => {
            try {
              let x = onRejected(error);
              resolve(x);
            } catch (e) {
              reject(e);
            }
          });
        });
      }
      //...
    }
    å¤åˆ¶ä»£ç 

å‡è‹¥å½“å‰çŠ¶æ€ä¸º PENDINGï¼Œå°†å›è°ƒæ•°ç»„ä¸­æ·»åŠ å¦‚ä¸Šçš„å‡½æ•°ï¼Œå½“ Promise çŠ¶æ€å˜åŒ–åï¼Œä¼šéå†ç›¸åº”å›è°ƒæ•°ç»„å¹¶æ‰§è¡Œå›è°ƒã€‚

ä½†æ˜¯è¿™æ®µç¨‹åº¦è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜:

1.  é¦–å…ˆ then ä¸­çš„ä¸¤ä¸ªå‚æ•°ä¸ä¼ çš„æƒ…å†µå¹¶æ²¡æœ‰å¤„ç†ï¼Œ
2.  å‡å¦‚ then ä¸­çš„å›è°ƒæ‰§è¡Œåè¿”å›çš„ç»“æœ(ä¹Ÿå°±æ˜¯ä¸Šé¢çš„`x`)æ˜¯ä¸€ä¸ª Promise, ç›´æ¥ç»™ resolve äº†ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚

æ€ä¹ˆæ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜å‘¢ï¼Ÿ

å…ˆå¯¹å‚æ•°ä¸ä¼ çš„æƒ…å†µåšåˆ¤æ–­:

    // æˆåŠŸå›è°ƒä¸ä¼ ç»™å®ƒä¸€ä¸ªé»˜è®¤å‡½æ•°
    onFulfilled = typeof onFulfilled === "function" ? onFulfilled : value => value;
    // å¯¹äºå¤±è´¥å›è°ƒç›´æ¥æŠ›é”™
    onRejected = typeof onRejected === "function" ? onRejected : error => { throw error };
    å¤åˆ¶ä»£ç 

ç„¶åå¯¹`è¿”å›Promise`çš„æƒ…å†µè¿›è¡Œå¤„ç†:

    function resolvePromise(bridgePromise, x, resolve, reject) {
      //å¦‚æœxæ˜¯ä¸€ä¸ªpromise
      if (x instanceof MyPromise) {
        // æ‹†è§£è¿™ä¸ª promise ï¼Œç›´åˆ°è¿”å›å€¼ä¸ä¸º promise ä¸ºæ­¢
        if (x.status === PENDING) {
          x.then(y => {
            resolvePromise(bridgePromise, y, resolve, reject);
          }, error => {
            reject(error);
          });
        } else {
          x.then(resolve, reject);
        }
      } else {
        // é Promise çš„è¯ç›´æ¥ resolve å³å¯
        resolve(x);
      }
    }
    å¤åˆ¶ä»£ç 

ç„¶ååœ¨ then çš„æ–¹æ³•å®ç°ä¸­ä½œå¦‚ä¸‹ä¿®æ”¹:

    resolve(x)  ->  resolvePromise(bridgePromise, x, resolve, reject);
    å¤åˆ¶ä»£ç 

åœ¨è¿™é‡Œå¤§å®¶å¥½å¥½ä½“ä¼šä¸€ä¸‹æ‹†è§£ Promise çš„è¿‡ç¨‹ï¼Œå…¶å®ä¸éš¾ç†è§£ï¼Œæˆ‘è¦å¼ºè°ƒçš„æ˜¯å…¶ä¸­çš„é€’å½’è°ƒç”¨å§‹ç»ˆä¼ å…¥çš„`resolve`å’Œ`reject`è¿™ä¸¤ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Œå…¶å®ä»–ä»¬æ§åˆ¶çš„æ˜¯æœ€å¼€å§‹ä¼ å…¥çš„`bridgePromise`çš„çŠ¶æ€ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸‹å½“ Promise çŠ¶æ€ä¸ä¸º PENDING æ—¶çš„é€»è¾‘ã€‚

æˆåŠŸçŠ¶æ€ä¸‹è°ƒç”¨thenï¼š

    if (self.status === FULFILLED) {
      return bridgePromise = new MyPromise((resolve, reject) => {
        try {
          // çŠ¶æ€å˜ä¸ºæˆåŠŸï¼Œä¼šæœ‰ç›¸åº”çš„ self.value
          let x = onFulfilled(self.value);
          // æš‚æ—¶å¯ä»¥ç†è§£ä¸º resolve(x)ï¼Œåé¢å…·ä½“å®ç°ä¸­æœ‰æ‹†è§£çš„è¿‡ç¨‹
          resolvePromise(bridgePromise, x, resolve, reject);
        } catch (e) {
          reject(e);
        }
      })
    }
    å¤åˆ¶ä»£ç 

å¤±è´¥çŠ¶æ€ä¸‹è°ƒç”¨thenï¼š

    if (self.status === REJECTED) {
      return bridgePromise = new MyPromise((resolve, reject) => {
        try {
          // çŠ¶æ€å˜ä¸ºå¤±è´¥ï¼Œä¼šæœ‰ç›¸åº”çš„ self.error
          let x = onRejected(self.error);
          resolvePromise(bridgePromise, x, resolve, reject);
        } catch (e) {
          reject(e);
        }
      });
    }
    å¤åˆ¶ä»£ç 

Promise A+ä¸­è§„å®šæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒéƒ½æ˜¯å¾®ä»»åŠ¡ï¼Œç”±äºæµè§ˆå™¨ä¸­ JS è§¦ç¢°ä¸åˆ°åº•å±‚å¾®ä»»åŠ¡çš„åˆ†é…ï¼Œå¯ä»¥ç›´æ¥æ‹¿ `setTimeout`(å±äº**å®ä»»åŠ¡**çš„èŒƒç•´) æ¥æ¨¡æ‹Ÿï¼Œç”¨ `setTimeout`å°†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡åŒ…è£¹ ï¼Œå½“ç„¶ï¼Œä¸Šé¢çš„ resolve å®ç°ä¹Ÿæ˜¯åŒç†, å¤§å®¶æ³¨æ„ä¸€ä¸‹å³å¯ï¼Œå…¶å®å¹¶ä¸æ˜¯çœŸæ­£çš„å¾®ä»»åŠ¡ã€‚

    if (self.status === FULFILLED) {
      return bridgePromise = new MyPromise((resolve, reject) => {
        setTimeout(() => {
          //...
        })
    }
    å¤åˆ¶ä»£ç 

    if (self.status === REJECTED) {
      return bridgePromise = new MyPromise((resolve, reject) => {
        setTimeout(() => {
          //...
        })
    }
    å¤åˆ¶ä»£ç 

å¥½äº†ï¼Œåˆ°è¿™é‡Œ, æˆ‘ä»¬åŸºæœ¬å®ç°äº† then æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬æ‹¿åˆšåˆšçš„æµ‹è¯•ä»£ç åšä¸€ä¸‹æµ‹è¯•, ä¾æ¬¡æ‰“å°å¦‚ä¸‹:

    001.txtçš„å†…å®¹
    002.txtçš„å†…å®¹
    å¤åˆ¶ä»£ç 

å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»å¯ä»¥é¡ºåˆ©åœ°å®Œæˆé“¾å¼è°ƒç”¨ã€‚

### é”™è¯¯æ•è·åŠå†’æ³¡æœºåˆ¶åˆ†æ

ç°åœ¨æ¥å®ç° catch æ–¹æ³•:

    Promise.prototype.catch = function (onRejected) {
      return this.then(null, onRejected);
    }
    å¤åˆ¶ä»£ç 

å¯¹ï¼Œå°±æ˜¯è¿™ä¹ˆå‡ è¡Œï¼Œcatch åŸæœ¬å°±æ˜¯ then æ–¹æ³•çš„è¯­æ³•ç³–ã€‚

ç›¸æ¯”äºå®ç°æ¥è®²ï¼Œæ›´é‡è¦çš„æ˜¯ç†è§£å…¶ä¸­é”™è¯¯å†’æ³¡çš„æœºåˆ¶ï¼Œå³ä¸­é€”ä¸€æ—¦å‘ç”Ÿé”™è¯¯ï¼Œå¯ä»¥åœ¨æœ€åç”¨ catch æ•è·é”™è¯¯ã€‚

æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ Promise çš„è¿ä½œæµç¨‹ä¹Ÿä¸éš¾ç†è§£ï¼Œè´´ä¸Šä¸€è¡Œå…³é”®çš„ä»£ç :

    // then çš„å®ç°ä¸­
    onRejected = typeof onRejected === "function" ? onRejected : error => { throw error };
    å¤åˆ¶ä»£ç 

ä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ª`PENDINGçŠ¶æ€`çš„ Promise å‡ºç°é”™è¯¯åçŠ¶æ€å¿…ç„¶ä¼šå˜ä¸º`å¤±è´¥`, ç„¶åæ‰§è¡Œ `onRejected`å‡½æ•°ï¼Œè€Œè¿™ä¸ª onRejected æ‰§è¡Œåˆä¼šæŠ›é”™ï¼ŒæŠŠæ–°çš„ Promise çŠ¶æ€å˜ä¸º`å¤±è´¥`ï¼Œæ–°çš„ Promise çŠ¶æ€å˜ä¸ºå¤±è´¥ååˆä¼šæ‰§è¡Œ`onRejected`......å°±è¿™æ ·ä¸€ç›´æŠ›ä¸‹å»ï¼Œç›´åˆ°ç”¨`catch` æ•è·åˆ°è¿™ä¸ªé”™è¯¯ï¼Œæ‰åœæ­¢å¾€ä¸‹æŠ›ã€‚

è¿™å°±æ˜¯ Promise çš„`é”™è¯¯å†’æ³¡æœºåˆ¶`ã€‚

è‡³æ­¤ï¼ŒPromise ä¸‰å¤§æ³•å®: `å›è°ƒå‡½æ•°å»¶è¿Ÿç»‘å®š`ã€`å›è°ƒè¿”å›å€¼ç©¿é€`å’Œ`é”™è¯¯å†’æ³¡`ã€‚

ç¬¬37ç¯‡: Promise ä¹‹é—®(å››)â€”â€”å®ç°Promiseçš„ resolveã€reject å’Œ finally
--------------------------------------------------------

### å®ç° Promise.resolve

å®ç° resolve é™æ€æ–¹æ³•æœ‰ä¸‰ä¸ªè¦ç‚¹:

*   1.  ä¼ å‚ä¸ºä¸€ä¸ª Promise, åˆ™ç›´æ¥è¿”å›å®ƒã€‚
*   2.  ä¼ å‚ä¸ºä¸€ä¸ª thenable å¯¹è±¡ï¼Œè¿”å›çš„ Promise ä¼šè·Ÿéšè¿™ä¸ªå¯¹è±¡ï¼Œ`é‡‡ç”¨å®ƒçš„æœ€ç»ˆçŠ¶æ€`ä½œä¸º`è‡ªå·±çš„çŠ¶æ€`ã€‚
*   3.  å…¶ä»–æƒ…å†µï¼Œç›´æ¥è¿”å›ä»¥è¯¥å€¼ä¸ºæˆåŠŸçŠ¶æ€çš„promiseå¯¹è±¡ã€‚

å…·ä½“å®ç°å¦‚ä¸‹:

    Promise.resolve = (param) => {
      if(param instanceof Promise) return param;
      return new Promise((resolve, reject) => {
        if(param && param.then && typeof param.then === 'function') {
          // param çŠ¶æ€å˜ä¸ºæˆåŠŸä¼šè°ƒç”¨resolveï¼Œå°†æ–° Promise çš„çŠ¶æ€å˜ä¸ºæˆåŠŸï¼Œåä¹‹äº¦ç„¶
          param.then(resolve, reject);
        }else {
          resolve(param);
        }
      })
    }
    å¤åˆ¶ä»£ç 

### å®ç° Promise.reject

Promise.reject ä¸­ä¼ å…¥çš„å‚æ•°ä¼šä½œä¸ºä¸€ä¸ª reason åŸå°ä¸åŠ¨åœ°å¾€ä¸‹ä¼ , å®ç°å¦‚ä¸‹:

    Promise.reject = function (reason) {
        return new Promise((resolve, reject) => {
            reject(reason);
        });
    }
    å¤åˆ¶ä»£ç 

### å®ç° Promise.prototype.finally

æ— è®ºå½“å‰ Promise æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè°ƒç”¨`finally`ä¹‹åéƒ½ä¼šæ‰§è¡Œ finally ä¸­ä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¸”å°†å€¼åŸå°ä¸åŠ¨çš„å¾€ä¸‹ä¼ ã€‚

    Promise.prototype.finally = function(callback) {
      this.then(value => {
        return Promise.resolve(callback()).then(() => {
          return value;
        })
      }, error => {
        return Promise.resolve(callback()).then(() => {
          throw error;
        })
      })
    }
    å¤åˆ¶ä»£ç 

ç¬¬38ç¯‡: Promise ä¹‹é—®(äº”)â€”â€”å®ç°Promiseçš„ all å’Œ race
------------------------------------------

### å®ç° Promise.all

å¯¹äº all æ–¹æ³•è€Œè¨€ï¼Œéœ€è¦å®Œæˆä¸‹é¢çš„æ ¸å¿ƒåŠŸèƒ½:

1.  ä¼ å…¥å‚æ•°ä¸ºä¸€ä¸ªç©ºçš„å¯è¿­ä»£å¯¹è±¡ï¼Œåˆ™`ç›´æ¥è¿›è¡Œresolve`ã€‚
2.  å¦‚æœå‚æ•°ä¸­`æœ‰ä¸€ä¸ª`promiseå¤±è´¥ï¼Œé‚£ä¹ˆPromise.allè¿”å›çš„promiseå¯¹è±¡å¤±è´¥ã€‚
3.  åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼ŒPromise.all è¿”å›çš„ promise çš„å®ŒæˆçŠ¶æ€çš„ç»“æœéƒ½æ˜¯ä¸€ä¸ª`æ•°ç»„`

å…·ä½“å®ç°å¦‚ä¸‹:

    Promise.all = function(promises) {
      return new Promise((resolve, reject) => {
        let result = [];
        let index = 0;
        let len = promises.length;
        if(len === 0) {
          resolve(result);
          return;
        }
       
        for(let i = 0; i < len; i++) {
          // ä¸ºä»€ä¹ˆä¸ç›´æ¥ promise[i].then, å› ä¸ºpromise[i]å¯èƒ½ä¸æ˜¯ä¸€ä¸ªpromise
          Promise.resolve(promise[i]).then(data => {
            result[i] = data;
            index++;
            if(index === len) resolve(result);
          }).catch(err => {
            reject(err);
          })
        }
      })
    }
    å¤åˆ¶ä»£ç 

### å®ç° Promise.race

race çš„å®ç°ç›¸æ¯”ä¹‹ä¸‹å°±ç®€å•ä¸€äº›ï¼Œåªè¦æœ‰ä¸€ä¸ª promise æ‰§è¡Œå®Œï¼Œç›´æ¥ resolve å¹¶åœæ­¢æ‰§è¡Œã€‚

    Promise.race = function(promises) {
      return new Promise((resolve, reject) => {
        let len = promises.length;
        if(len === 0) return;
        for(let i = 0; i < len; i++) {
          Promise.resolve(promise[i]).then(data => {
            resolve(data);
            return;
          }).catch(err => {
            reject(err);
            return;
          })
        }
      })
    }
    å¤åˆ¶ä»£ç 

åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ªå®Œæ•´çš„ Promise å°±è¢«æˆ‘ä»¬å®ç°å®Œå•¦ã€‚ä»åŸç†åˆ°ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£å’Œå®ç°ï¼Œå¸Œæœ›å¤§å®¶åœ¨çŸ¥é“ Promise è®¾è®¡ä¸Šçš„å‡ å¤§äº®ç‚¹ä¹‹åï¼Œä¹Ÿèƒ½è‡ªå·±æ‰‹åŠ¨å®ç°ä¸€ä¸ªPromiseï¼Œè®©è‡ªå·±çš„æ€ç»´å±‚æ¬¡å’ŒåŠ¨æ‰‹èƒ½åŠ›æ›´ä¸Šä¸€å±‚æ¥¼ï¼

ç¬¬39ç¯‡: è°ˆè°ˆä½ å¯¹ç”Ÿæˆå™¨ä»¥åŠåç¨‹çš„ç†è§£ã€‚
---------------------

ç”Ÿæˆå™¨(Generator)æ˜¯ ES6 ä¸­çš„æ–°è¯­æ³•ï¼Œç›¸å¯¹äºä¹‹å‰çš„å¼‚æ­¥è¯­æ³•ï¼Œä¸Šæ‰‹çš„éš¾åº¦è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬å…ˆæ¥å¥½å¥½ç†Ÿæ‚‰ä¸€ä¸‹ Generator è¯­æ³•ã€‚

### ç”Ÿæˆå™¨æ‰§è¡Œæµç¨‹

ä¸Šé¢æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼Ÿ

ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªå¸¦`æ˜Ÿå·`çš„"å‡½æ•°"(æ³¨æ„ï¼šå®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„å‡½æ•°)ï¼Œå¯ä»¥é€šè¿‡`yield`å…³é”®å­—`æš‚åœæ‰§è¡Œ`å’Œ`æ¢å¤æ‰§è¡Œ`çš„

ä¸¾ä¸ªä¾‹å­:

    function* gen() {
      console.log("enter");
      let a = yield 1;
      let b = yield (function () {return 2})();
      return 3;
    }
    var g = gen() // é˜»å¡ä½ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•è¯­å¥
    console.log(typeof g)  // object  çœ‹åˆ°äº†å—ï¼Ÿä¸æ˜¯"function"
    
    console.log(g.next())  
    console.log(g.next())  
    console.log(g.next())  
    console.log(g.next()) 
    
    
    // enter
    // { value: 1, done: false }
    
    // { value: 2, done: false }
    // { value: 3, done: true }
    // { value: undefined, done: true }
    å¤åˆ¶ä»£ç 

ç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆå™¨çš„æ‰§è¡Œæœ‰è¿™æ ·å‡ ä¸ªå…³é”®ç‚¹:

1.  è°ƒç”¨ gen() åï¼Œç¨‹åºä¼šé˜»å¡ä½ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•è¯­å¥ã€‚
2.  è°ƒç”¨ g.next() åï¼Œç¨‹åºç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ° yield ç¨‹åºæš‚åœã€‚
3.  next æ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œ æœ‰ä¸¤ä¸ªå±æ€§: `value` å’Œ `done`ã€‚value ä¸º`å½“å‰ yield åé¢çš„ç»“æœ`ï¼Œdone è¡¨ç¤º`æ˜¯å¦æ‰§è¡Œå®Œ`ï¼Œé‡åˆ°äº†`return` åï¼Œ`done` ä¼šç”±`false`å˜ä¸º`true`ã€‚

### yield\*

å½“ä¸€ä¸ªç”Ÿæˆå™¨è¦è°ƒç”¨å¦ä¸€ä¸ªç”Ÿæˆå™¨æ—¶ï¼Œä½¿ç”¨ yield\* å°±å˜å¾—ååˆ†æ–¹ä¾¿ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­:

    function* gen1() {
        yield 1;
        yield 4;
    }
    function* gen2() {
        yield 2;
        yield 3;
    }
    å¤åˆ¶ä»£ç 

æˆ‘ä»¬æƒ³è¦æŒ‰ç…§`1234`çš„é¡ºåºæ‰§è¡Œï¼Œå¦‚ä½•æ¥åšå‘¢ï¼Ÿ

åœ¨ `gen1` ä¸­ï¼Œä¿®æ”¹å¦‚ä¸‹:

    function* gen1() {
        yield 1;
        yield* gen2();
        yield 4;
    }
    å¤åˆ¶ä»£ç 

è¿™æ ·ä¿®æ”¹ä¹‹åï¼Œä¹‹åä¾æ¬¡è°ƒç”¨`next`å³å¯ã€‚

### ç”Ÿæˆå™¨å®ç°æœºåˆ¶â€”â€”åç¨‹

å¯èƒ½ä½ ä¼šæ¯”è¾ƒå¥½å¥‡ï¼Œç”Ÿæˆå™¨ç©¶ç«Ÿæ˜¯å¦‚ä½•è®©å‡½æ•°æš‚åœ, åˆä¼šå¦‚ä½•æ¢å¤çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å¯¹å…¶ä¸­çš„æ‰§è¡Œæœºåˆ¶â€”â€”`åç¨‹`ä¸€æ¢ç©¶ç«Ÿã€‚

#### ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

åç¨‹æ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å­˜åœ¨ï¼Œåç¨‹å¤„åœ¨çº¿ç¨‹çš„ç¯å¢ƒä¸­ï¼Œ`ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹`ï¼Œå¯ä»¥å°†åç¨‹ç†è§£ä¸ºçº¿ç¨‹ä¸­çš„ä¸€ä¸ªä¸ªä»»åŠ¡ã€‚ä¸åƒè¿›ç¨‹å’Œçº¿ç¨‹ï¼Œåç¨‹å¹¶ä¸å—æ“ä½œç³»ç»Ÿçš„ç®¡ç†ï¼Œè€Œæ˜¯è¢«å…·ä½“çš„åº”ç”¨ç¨‹åºä»£ç æ‰€æ§åˆ¶ã€‚

#### åç¨‹çš„è¿ä½œè¿‡ç¨‹

é‚£ä½ å¯èƒ½è¦é—®äº†ï¼ŒJS ä¸æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„å—ï¼Œå¼€è¿™ä¹ˆå¤šåç¨‹éš¾é“å¯ä»¥ä¸€èµ·æ‰§è¡Œå—ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šå¹¶ä¸èƒ½ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªåç¨‹ã€‚æ¯”å¦‚å½“å‰æ‰§è¡Œ A åç¨‹ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª B åç¨‹ï¼Œå¦‚æœæƒ³è¦æ‰§è¡Œ B çš„ä»»åŠ¡ï¼Œå°±å¿…é¡»åœ¨ A åç¨‹ä¸­å°†`JS çº¿ç¨‹çš„æ§åˆ¶æƒè½¬äº¤ç»™ Båç¨‹`ï¼Œé‚£ä¹ˆç°åœ¨ B æ‰§è¡Œï¼ŒA å°±ç›¸å½“äºå¤„äºæš‚åœçš„çŠ¶æ€ã€‚

ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­:

    function* A() {
      console.log("æˆ‘æ˜¯A");
      yield B(); // Aåœä½ï¼Œåœ¨è¿™é‡Œè½¬äº¤çº¿ç¨‹æ‰§è¡Œæƒç»™B
      console.log("ç»“æŸäº†");
    }
    function B() {
      console.log("æˆ‘æ˜¯B");
      return 100;// è¿”å›ï¼Œå¹¶ä¸”å°†çº¿ç¨‹æ‰§è¡Œæƒè¿˜ç»™A
    }
    let gen = A();
    gen.next();
    gen.next();
    
    // æˆ‘æ˜¯A
    // æˆ‘æ˜¯B
    // ç»“æŸäº†
    å¤åˆ¶ä»£ç 

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒA å°†æ‰§è¡Œæƒäº¤ç»™ Bï¼Œä¹Ÿå°±æ˜¯ `A å¯åŠ¨ B`ï¼Œæˆ‘ä»¬ä¹Ÿç§° A æ˜¯ B çš„**çˆ¶åç¨‹**ã€‚å› æ­¤ B å½“ä¸­æœ€å`return 100`å…¶å®æ˜¯å°† 100 ä¼ ç»™äº†çˆ¶åç¨‹ã€‚

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå¯¹äºåç¨‹æ¥è¯´ï¼Œå®ƒå¹¶ä¸å—æ“ä½œç³»ç»Ÿçš„æ§åˆ¶ï¼Œå®Œå…¨ç”±ç”¨æˆ·è‡ªå®šä¹‰åˆ‡æ¢ï¼Œå› æ­¤å¹¶æ²¡æœ‰è¿›ç¨‹/çº¿ç¨‹`ä¸Šä¸‹æ–‡åˆ‡æ¢`çš„å¼€é”€ï¼Œè¿™æ˜¯`é«˜æ€§èƒ½`çš„é‡è¦åŸå› ã€‚

OK, åŸç†å°±è¯´åˆ°è¿™é‡Œã€‚å¯èƒ½ä½ è¿˜ä¼šæœ‰ç–‘é—®: è¿™ä¸ªç”Ÿæˆå™¨ä¸å°±æš‚åœ-æ¢å¤ã€æš‚åœ-æ¢å¤è¿™æ ·æ‰§è¡Œçš„å—ï¼Ÿå®ƒå’Œå¼‚æ­¥æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿè€Œä¸”ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½è¦è°ƒç”¨nextï¼Œèƒ½ä¸èƒ½è®©å®ƒä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ¯•å‘¢ï¼Ÿä¸‹ä¸€èŠ‚æˆ‘ä»¬å°±æ¥ä»”ç»†æ‹†è§£è¿™äº›é—®é¢˜ã€‚

ç¬¬40ç¯‡: å¦‚ä½•è®© Generator çš„å¼‚æ­¥ä»£ç æŒ‰é¡ºåºæ‰§è¡Œå®Œæ¯•ï¼Ÿ
---------------------------------

è¿™é‡Œé¢å…¶å®æœ‰ä¸¤ä¸ªé—®é¢˜:

1.  `Generator` å¦‚ä½•è·Ÿ`å¼‚æ­¥`äº§ç”Ÿå…³ç³»ï¼Ÿ
2.  æ€ä¹ˆæŠŠ `Generator` æŒ‰é¡ºåºæ‰§è¡Œå®Œæ¯•ï¼Ÿ

### thunk å‡½æ•°

è¦æƒ³çŸ¥é“ `Generator` è·Ÿå¼‚æ­¥çš„å…³ç³»ï¼Œé¦–å…ˆå¸¦å¤§å®¶ææ¸…æ¥šä¸€ä¸ªæ¦‚å¿µâ€”â€”thunkå‡½æ•°(å³`åå‡½æ•°`)ï¼Œè™½ç„¶è¿™åªæ˜¯å®ç°ä¸¤è€…å…³ç³»çš„æ–¹å¼ä¹‹ä¸€ã€‚(å¦ä¸€ç§æ–¹å¼æ˜¯`Promise`, åé¢ä¼šè®²åˆ°)

ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦åˆ¤æ–­æ•°æ®ç±»å‹ã€‚å¯ä»¥å†™å¦‚ä¸‹çš„åˆ¤æ–­é€»è¾‘:

    let isString = (obj) => {
      return Object.prototype.toString.call(obj) === '[object String]';
    };
    let isFunction = (obj) => {
      return Object.prototype.toString.call(obj) === '[object Function]';
    };
    let isArray = (obj) => {
      return Object.prototype.toString.call(obj) === '[object Array]';
    };
    let isSet = (obj) => {
      return Object.prototype.toString.call(obj) === '[object Set]';
    };
    // ...
    å¤åˆ¶ä»£ç 

å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°äº†éå¸¸å¤šé‡å¤çš„é€»è¾‘ã€‚æˆ‘ä»¬å°†å®ƒä»¬åšä¸€ä¸‹å°è£…:

    let isType = (type) => {
      return (obj) => {
        return Object.prototype.toString.call(obj) === `[object ${type}]`;
      }
    }
    å¤åˆ¶ä»£ç 

ç°åœ¨æˆ‘ä»¬è¿™æ ·åšå³å¯:

    let isString = isType('String');
    let isFunction = isType('Function');
    //...
    å¤åˆ¶ä»£ç 

ç›¸åº”çš„ `isString`å’Œ`isFunction`æ˜¯ç”±`isType`ç”Ÿäº§å‡ºæ¥çš„å‡½æ•°ï¼Œä½†å®ƒä»¬ä¾ç„¶å¯ä»¥åˆ¤æ–­å‡ºå‚æ•°æ˜¯å¦ä¸ºStringï¼ˆFunctionï¼‰ï¼Œè€Œä¸”ä»£ç ç®€æ´äº†ä¸å°‘ã€‚

    isString("123");
    isFunction(val => val);
    å¤åˆ¶ä»£ç 

**isType**è¿™æ ·çš„å‡½æ•°æˆ‘ä»¬ç§°ä¸º**thunk å‡½æ•°**ã€‚å®ƒçš„æ ¸å¿ƒé€»è¾‘æ˜¯æ¥æ”¶ä¸€å®šçš„å‚æ•°ï¼Œç”Ÿäº§å‡ºå®šåˆ¶åŒ–çš„å‡½æ•°ï¼Œç„¶åä½¿ç”¨å®šåˆ¶åŒ–çš„å‡½æ•°å»å®ŒæˆåŠŸèƒ½ã€‚thunkå‡½æ•°çš„å®ç°ä¼šæ¯”å•ä¸ªçš„åˆ¤æ–­å‡½æ•°å¤æ‚ä¸€ç‚¹ç‚¹ï¼Œä½†å°±æ˜¯è¿™ä¸€ç‚¹ç‚¹çš„å¤æ‚ï¼Œå¤§å¤§æ–¹ä¾¿äº†åç»­çš„æ“ä½œã€‚

### Generator å’Œ å¼‚æ­¥

#### thunk ç‰ˆæœ¬

ä»¥`æ–‡ä»¶æ“ä½œ`ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ **å¼‚æ­¥æ“ä½œ** å¦‚ä½•åº”ç”¨äº`Generator`ã€‚

    const readFileThunk = (filename) => {
      return (callback) => {
        fs.readFile(filename, callback);
      }
    }
    å¤åˆ¶ä»£ç 

`readFileThunk`å°±æ˜¯ä¸€ä¸ª`thunkå‡½æ•°`ã€‚å¼‚æ­¥æ“ä½œæ ¸å¿ƒçš„ä¸€ç¯å°±æ˜¯ç»‘å®šå›è°ƒå‡½æ•°ï¼Œè€Œ`thunkå‡½æ•°`å¯ä»¥å¸®æˆ‘ä»¬åšåˆ°ã€‚é¦–å…ˆä¼ å…¥æ–‡ä»¶åï¼Œç„¶åç”Ÿæˆä¸€ä¸ªé’ˆå¯¹æŸä¸ªæ–‡ä»¶çš„å®šåˆ¶åŒ–å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸­ä¼ å…¥å›è°ƒï¼Œè¿™ä¸ªå›è°ƒå°±ä¼šæˆä¸ºå¼‚æ­¥æ“ä½œçš„å›è°ƒã€‚è¿™æ ·å°±è®© `Generator` å’Œ`å¼‚æ­¥`å…³è”èµ·æ¥äº†ã€‚

ç´§æ¥è€…æˆ‘ä»¬åšå¦‚ä¸‹çš„æ“ä½œ:

    const gen = function* () {
      const data1 = yield readFileThunk('001.txt')
      console.log(data1.toString())
      const data2 = yield readFileThunk('002.txt')
      console.log(data2.toString)
    }
    å¤åˆ¶ä»£ç 

æ¥ç€æˆ‘ä»¬è®©å®ƒæ‰§è¡Œå®Œ:

    let g = gen();
    // ç¬¬ä¸€æ­¥: ç”±äºè¿›åœºæ˜¯æš‚åœçš„ï¼Œæˆ‘ä»¬è°ƒç”¨nextï¼Œè®©å®ƒå¼€å§‹æ‰§è¡Œã€‚
    // nextè¿”å›å€¼ä¸­æœ‰ä¸€ä¸ªvalueå€¼ï¼Œè¿™ä¸ªvalueæ˜¯yieldåé¢çš„ç»“æœï¼Œæ”¾åœ¨è¿™é‡Œä¹Ÿå°±æ˜¯æ˜¯thunkå‡½æ•°ç”Ÿæˆçš„å®šåˆ¶åŒ–å‡½æ•°ï¼Œé‡Œé¢éœ€è¦ä¼ ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°
    g.next().value((err, data1) => {
      // ç¬¬äºŒæ­¥: æ‹¿åˆ°ä¸Šä¸€æ¬¡å¾—åˆ°çš„ç»“æœï¼Œè°ƒç”¨next, å°†ç»“æœä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œã€‚
      // åŒç†ï¼Œvalueä¼ å…¥å›è°ƒ
      g.next(data1).value((err, data2) => {
        g.next(data2);
      })
    })
    
    å¤åˆ¶ä»£ç 

æ‰“å°ç»“æœå¦‚ä¸‹:

    001.txtçš„å†…å®¹
    002.txtçš„å†…å®¹
    å¤åˆ¶ä»£ç 

ä¸Šé¢åµŒå¥—çš„æƒ…å†µè¿˜ç®—ç®€å•ï¼Œå¦‚æœä»»åŠ¡å¤šèµ·æ¥ï¼Œå°±ä¼šäº§ç”Ÿå¾ˆå¤šå±‚çš„åµŒå¥—ï¼Œå¯æ“ä½œæ€§ä¸å¼ºï¼Œæœ‰å¿…è¦æŠŠæ‰§è¡Œçš„ä»£ç å°è£…ä¸€ä¸‹:

    function run(gen){
      const next = (err, data) => {
        let res = gen.next(data);
        if(res.done) return;
        res.value(next);
      }
      next();
    }
    run(g);
    å¤åˆ¶ä»£ç 

Ok,å†æ¬¡æ‰§è¡Œï¼Œä¾ç„¶æ‰“å°æ­£ç¡®çš„ç»“æœã€‚ä»£ç è™½ç„¶å°±è¿™ä¹ˆå‡ è¡Œï¼Œä½†åŒ…å«äº†é€’å½’çš„è¿‡ç¨‹ï¼Œå¥½å¥½ä½“ä¼šä¸€ä¸‹ã€‚

è¿™æ˜¯é€šè¿‡`thunk`å®Œæˆå¼‚æ­¥æ“ä½œçš„æƒ…å†µã€‚

#### Promise ç‰ˆæœ¬

è¿˜æ˜¯æ‹¿ä¸Šé¢çš„ä¾‹å­ï¼Œç”¨`Promise`æ¥å®ç°å°±è½»æ¾ä¸€äº›:

    const readFilePromise = (filename) => {
      return new Promise((resolve, reject) => {
        fs.readFile(filename, (err, data) => {
          if(err) {
            reject(err);
          }else {
            resolve(data);
          }
        })
      }).then(res => res);
    }
    const gen = function* () {
      const data1 = yield readFilePromise('001.txt')
      console.log(data1.toString())
      const data2 = yield readFilePromise('002.txt')
      console.log(data2.toString)
    }
    å¤åˆ¶ä»£ç 

æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹:

    let g = gen();
    function getGenPromise(gen, data) { 
      return gen.next(data).value;
    }
    getGenPromise(g).then(data1 => {
      return getGenPromise(g, data1);
    }).then(data2 => {
      return getGenPromise(g, data2)
    })
    å¤åˆ¶ä»£ç 

æ‰“å°ç»“æœå¦‚ä¸‹:

    001.txtçš„å†…å®¹
    002.txtçš„å†…å®¹
    å¤åˆ¶ä»£ç 

åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ‰§è¡Œ`Generator`çš„ä»£ç åŠ ä»¥å°è£…:

    function run(g) {
      const next = (data) => {
        let res = g.next();
        if(res.done) return;
        res.value.then(data => {
          next(data);
        })
      }
      next();
    }
    å¤åˆ¶ä»£ç 

åŒæ ·èƒ½è¾“å‡ºæ­£ç¡®çš„ç»“æœã€‚ä»£ç éå¸¸ç²¾ç‚¼ï¼Œå¸Œæœ›èƒ½å‚ç…§åˆšåˆšé“¾å¼è°ƒç”¨çš„ä¾‹å­ï¼Œä»”ç»†ä½“ä¼šä¸€ä¸‹é€’å½’è°ƒç”¨çš„è¿‡ç¨‹ã€‚

### é‡‡ç”¨ co åº“

ä»¥ä¸Šæˆ‘ä»¬é’ˆå¯¹ `thunk å‡½æ•°`å’Œ`Promise`ä¸¤ç§`Generatorå¼‚æ­¥æ“ä½œ`çš„ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ¯•åšäº†å°è£…ï¼Œä½†å®é™…åœºæ™¯ä¸­å·²ç»å­˜åœ¨æˆç†Ÿçš„å·¥å…·åŒ…äº†ï¼Œå¦‚æœå¤§åé¼é¼çš„**co**åº“, å…¶å®æ ¸å¿ƒåŸç†å°±æ˜¯æˆ‘ä»¬å·²ç»æ‰‹å†™è¿‡äº†ï¼ˆå°±æ˜¯åˆšåˆšå°è£…çš„Promiseæƒ…å†µä¸‹çš„æ‰§è¡Œä»£ç ï¼‰ï¼Œåªä¸è¿‡æºç ä¼šå„ç§è¾¹ç•Œæƒ…å†µåšäº†å¤„ç†ã€‚ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•:

    const co = require('co');
    let g = gen();
    co(g).then(res =>{
      console.log(res);
    })
    å¤åˆ¶ä»£ç 

æ‰“å°ç»“æœå¦‚ä¸‹:

    001.txtçš„å†…å®¹
    002.txtçš„å†…å®¹
    100
    å¤åˆ¶ä»£ç 

ç®€å•å‡ è¡Œä»£ç å°±å®Œæˆäº†`Generator`æ‰€æœ‰çš„æ“ä½œï¼ŒçœŸä¸æ„§`co`å’Œ`Generator`å¤©ç”Ÿä¸€å¯¹å•Šï¼

ç¬¬41ç¯‡: è§£é‡Šä¸€ä¸‹async/awaitçš„è¿è¡Œæœºåˆ¶ã€‚
---------------------------

`async/await`è¢«ç§°ä¸º JS ä¸­**å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ**ã€‚å®ƒæ—¢èƒ½å¤Ÿåƒ co + Generator ä¸€æ ·ç”¨åŒæ­¥çš„æ–¹å¼æ¥ä¹¦å†™å¼‚æ­¥ä»£ç ï¼Œåˆå¾—åˆ°åº•å±‚çš„è¯­æ³•æ”¯æŒï¼Œæ— éœ€å€ŸåŠ©ä»»ä½•ç¬¬ä¸‰æ–¹åº“ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»åŸç†çš„è§’åº¦æ¥é‡æ–°å®¡è§†è¿™ä¸ªè¯­æ³•ç³–èƒŒåç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆã€‚

### async

ä»€ä¹ˆæ˜¯ async ?

> MDN çš„å®šä¹‰: async æ˜¯ä¸€ä¸ªé€šè¿‡å¼‚æ­¥æ‰§è¡Œå¹¶éšå¼è¿”å› Promise ä½œä¸ºç»“æœçš„å‡½æ•°ã€‚

æ³¨æ„é‡ç‚¹: **è¿”å›ç»“æœä¸ºPromise**ã€‚

ä¸¾ä¸ªä¾‹å­:

    async function func() {
      return 100;
    }
    console.log(func());
    // PromiseÂ {<resolved>: 100}
    å¤åˆ¶ä»£ç 

è¿™å°±æ˜¯éšå¼è¿”å› Promise çš„æ•ˆæœã€‚

### await

æˆ‘ä»¬æ¥çœ‹çœ‹ `await`åšäº†äº›ä»€ä¹ˆäº‹æƒ…ã€‚

ä»¥ä¸€æ®µä»£ç ä¸ºä¾‹:

    async function test() {
      console.log(100)
      let x = await 200
      console.log(x)
      console.log(200)
    }
    console.log(0)
    test()
    console.log(300)
    å¤åˆ¶ä»£ç 

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ®µç¨‹åºã€‚é¦–å…ˆä»£ç åŒæ­¥æ‰§è¡Œï¼Œæ‰“å°å‡º`0`ï¼Œç„¶åå°†`test`å‹å…¥æ‰§è¡Œæ ˆï¼Œæ‰“å°å‡º`100`, ä¸‹é¢æ³¨æ„äº†ï¼Œé‡åˆ°äº†å…³é”®è§’è‰²**await**ã€‚

æ”¾ä¸ªæ…¢é•œå¤´:

    await 100;
    å¤åˆ¶ä»£ç 

è¢« JS å¼•æ“è½¬æ¢æˆä¸€ä¸ª Promise :

    let promise = new Promise((resolve,reject) => {
       resolve(100);
    })
    å¤åˆ¶ä»£ç 

è¿™é‡Œè°ƒç”¨äº† resolveï¼Œresolveçš„ä»»åŠ¡è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

ç„¶åï¼ŒJS å¼•æ“å°†æš‚åœå½“å‰åç¨‹çš„è¿è¡Œï¼ŒæŠŠçº¿ç¨‹çš„æ‰§è¡Œæƒäº¤ç»™`çˆ¶åç¨‹`(çˆ¶åç¨‹ä¸æ‡‚æ˜¯ä»€ä¹ˆçš„ï¼Œä¸Šä¸Šç¯‡æ‰è®²ï¼Œå›å»è¡¥è¯¾)ã€‚

å›åˆ°çˆ¶åç¨‹ä¸­ï¼Œçˆ¶åç¨‹çš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯å¯¹`await`è¿”å›çš„`Promise`è°ƒç”¨`then`, æ¥ç›‘å¬è¿™ä¸ª Promise çš„çŠ¶æ€æ”¹å˜ ã€‚

    promise.then(value => {
      // ç›¸å…³é€»è¾‘ï¼Œåœ¨resolve æ‰§è¡Œä¹‹åæ¥è°ƒç”¨
    })
    å¤åˆ¶ä»£ç 

ç„¶åå¾€ä¸‹æ‰§è¡Œï¼Œæ‰“å°å‡º`300`ã€‚

æ ¹æ®`EventLoop`æœºåˆ¶ï¼Œå½“å‰ä¸»çº¿ç¨‹çš„å®ä»»åŠ¡å®Œæˆï¼Œç°åœ¨æ£€æŸ¥`å¾®ä»»åŠ¡é˜Ÿåˆ—`, å‘ç°è¿˜æœ‰ä¸€ä¸ªPromiseçš„ resolveï¼Œæ‰§è¡Œï¼Œç°åœ¨çˆ¶åç¨‹åœ¨`then`ä¸­ä¼ å…¥çš„å›è°ƒæ‰§è¡Œã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå›è°ƒå…·ä½“åšçš„æ˜¯ä»€ä¹ˆã€‚

    promise.then(value => {
      // 1. å°†çº¿ç¨‹çš„æ‰§è¡Œæƒäº¤ç»™teståç¨‹
      // 2. æŠŠ value å€¼ä¼ é€’ç»™ test åç¨‹
    })
    å¤åˆ¶ä»£ç 

Ok, ç°åœ¨æ‰§è¡Œæƒåˆ°äº†`teståç¨‹`æ‰‹ä¸Šï¼Œtest æ¥æ”¶åˆ°`çˆ¶åç¨‹`ä¼ æ¥çš„**200**, èµ‹å€¼ç»™ a ,ç„¶åä¾æ¬¡æ‰§è¡Œåé¢çš„è¯­å¥ï¼Œæ‰“å°`200`ã€`200`ã€‚

æœ€åçš„è¾“å‡ºä¸º:

    0
    100
    300
    200
    200
    å¤åˆ¶ä»£ç 

æ€»ç»“ä¸€ä¸‹ï¼Œ`async/await`åˆ©ç”¨`åç¨‹`å’Œ`Promise`å®ç°äº†åŒæ­¥æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç çš„æ•ˆæœï¼Œå…¶ä¸­`Generator`æ˜¯å¯¹`åç¨‹`çš„ä¸€ç§å®ç°ï¼Œè™½ç„¶è¯­æ³•ç®€å•ï¼Œä½†å¼•æ“åœ¨èƒŒååšäº†å¤§é‡çš„å·¥ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯¹è¿™äº›å·¥ä½œåšäº†ä¸€ä¸€çš„æ‹†è§£ã€‚ç”¨`async/await`å†™å‡ºçš„ä»£ç ä¹Ÿæ›´åŠ ä¼˜é›…ã€ç¾è§‚ï¼Œç›¸æ¯”äºä¹‹å‰çš„`Promise`ä¸æ–­è°ƒç”¨thençš„æ–¹å¼ï¼Œè¯­ä¹‰åŒ–æ›´åŠ æ˜æ˜¾ï¼Œç›¸æ¯”äº`co + Generator`æ€§èƒ½æ›´é«˜ï¼Œä¸Šæ‰‹æˆæœ¬ä¹Ÿæ›´ä½ï¼Œä¸æ„§æ˜¯JSå¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆï¼

ç¬¬42ç¯‡: forEach ä¸­ç”¨ await ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜?æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ
----------------------------------------

### é—®é¢˜

é—®é¢˜:**å¯¹äºå¼‚æ­¥ä»£ç ï¼ŒforEach å¹¶ä¸èƒ½ä¿è¯æŒ‰é¡ºåºæ‰§è¡Œã€‚**

ä¸¾ä¸ªä¾‹å­:

    async function test() {
    	let arr = [4, 2, 1]
    	arr.forEach(async item => {
    		const res = await handle(item)
    		console.log(res)
    	})
    	console.log('ç»“æŸ')
    }
    
    function handle(x) {
    	return new Promise((resolve, reject) => {
    		setTimeout(() => {
    			resolve(x)
    		}, 1000 * x)
    	})
    }
    
    test()
    å¤åˆ¶ä»£ç 

æˆ‘ä»¬æœŸæœ›çš„ç»“æœæ˜¯:

    4 
    2 
    1
    ç»“æŸ
    å¤åˆ¶ä»£ç 

ä½†æ˜¯å®é™…ä¸Šä¼šè¾“å‡º:

    ç»“æŸ
    1
    2
    4
    å¤åˆ¶ä»£ç 

### é—®é¢˜åŸå› 

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘æƒ³æˆ‘ä»¬æœ‰å¿…è¦çœ‹çœ‹`forEach`åº•å±‚æ€ä¹ˆå®ç°çš„ã€‚

    // æ ¸å¿ƒé€»è¾‘
    for (var i = 0; i < length; i++) {
      if (i in array) {
        var element = array[i];
        callback(element, i, array);
      }
    }
    å¤åˆ¶ä»£ç 

å¯ä»¥çœ‹åˆ°ï¼ŒforEach æ‹¿è¿‡æ¥ç›´æ¥æ‰§è¡Œäº†ï¼Œè¿™å°±å¯¼è‡´å®ƒæ— æ³•ä¿è¯å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºã€‚æ¯”å¦‚åé¢çš„ä»»åŠ¡ç”¨æ—¶çŸ­ï¼Œé‚£ä¹ˆå°±åˆå¯èƒ½æŠ¢åœ¨å‰é¢çš„ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚

### è§£å†³æ–¹æ¡ˆ

å¦‚ä½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

å…¶å®ä¹Ÿå¾ˆç®€å•, æˆ‘ä»¬åˆ©ç”¨`for...of`å°±èƒ½è½»æ¾è§£å†³ã€‚

    async function test() {
      let arr = [4, 2, 1]
      for(const item of arr) {
    	const res = await handle(item)
    	console.log(res)
      }
    	console.log('ç»“æŸ')
    }
    å¤åˆ¶ä»£ç 

### è§£å†³åŸç†â€”â€”Iterator

å¥½äº†ï¼Œè¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥å¥½åƒå¾ˆç®€å•å°±èƒ½æå®šï¼Œä½ æœ‰æƒ³è¿‡è¿™ä¹ˆåšä¸ºä»€ä¹ˆå¯ä»¥æˆåŠŸå—ï¼Ÿ

å…¶å®ï¼Œfor...ofå¹¶ä¸åƒforEaché‚£ä¹ˆç®€å•ç²—æš´çš„æ–¹å¼å»éå†æ‰§è¡Œï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§ç‰¹åˆ«çš„æ‰‹æ®µâ€”â€”`è¿­ä»£å™¨`å»éå†ã€‚

é¦–å…ˆï¼Œå¯¹äºæ•°ç»„æ¥è®²ï¼Œå®ƒæ˜¯ä¸€ç§`å¯è¿­ä»£æ•°æ®ç±»å‹`ã€‚é‚£ä»€ä¹ˆæ˜¯`å¯è¿­ä»£æ•°æ®ç±»å‹`å‘¢ï¼Ÿ

> åŸç”Ÿå…·æœ‰\[Symbol.iterator\]å±æ€§æ•°æ®ç±»å‹ä¸ºå¯è¿­ä»£æ•°æ®ç±»å‹ã€‚å¦‚æ•°ç»„ã€ç±»æ•°ç»„ï¼ˆå¦‚argumentsã€NodeListï¼‰ã€Setå’ŒMapã€‚

å¯è¿­ä»£å¯¹è±¡å¯ä»¥é€šè¿‡è¿­ä»£å™¨è¿›è¡Œéå†ã€‚

    let arr = [4, 2, 1];
    // è¿™å°±æ˜¯è¿­ä»£å™¨
    let iterator = arr[Symbol.iterator]();
    console.log(iterator.next());
    console.log(iterator.next());
    console.log(iterator.next());
    console.log(iterator.next());
    
    
    // {value: 4, done: false}
    // {value: 2, done: false}
    // {value: 1, done: false}
    // {value: undefined, done: true}
    å¤åˆ¶ä»£ç 

å› æ­¤ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥è¿™æ ·æ¥ç»„ç»‡:

    async function test() {
      let arr = [4, 2, 1]
      let iterator = arr[Symbol.iterator]();
      let res = iterator.next();
      while(!res.done) {
        let value = res.value;
        console.log(value);
        await handle(value);
        res = iterater.next();
      }
    	console.log('ç»“æŸ')
    }
    // 4
    // 2
    // 1
    // ç»“æŸ
    å¤åˆ¶ä»£ç 

å¤šä¸ªä»»åŠ¡æˆåŠŸåœ°æŒ‰é¡ºåºæ‰§è¡Œï¼å…¶å®åˆšåˆšçš„for...ofå¾ªç¯ä»£ç å°±æ˜¯è¿™æ®µä»£ç çš„è¯­æ³•ç³–ã€‚

### é‡æ–°è®¤è¯†ç”Ÿæˆå™¨

å›å¤´å†çœ‹çœ‹ç”¨iteratoréå†\[4,2,1\]è¿™ä¸ªæ•°ç»„çš„ä»£ç ã€‚

    let arr = [4, 2, 1];
    // è¿­ä»£å™¨
    let iterator = arr[Symbol.iterator]();
    console.log(iterator.next());
    console.log(iterator.next());
    console.log(iterator.next());
    console.log(iterator.next());
    
    
    // {value: 4, done: false}
    // {value: 2, done: false}
    // {value: 1, done: false}
    // {value: undefined, done: true}
    å¤åˆ¶ä»£ç 

å’¦ï¼Ÿè¿”å›å€¼æœ‰`value`å’Œ`done`å±æ€§ï¼Œç”Ÿæˆå™¨ä¹Ÿå¯ä»¥è°ƒç”¨ next,è¿”å›çš„ä¹Ÿæ˜¯è¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¹ˆå·§?!

æ²¡é”™ï¼Œ**ç”Ÿæˆå™¨**æœ¬èº«å°±æ˜¯ä¸€ä¸ª**è¿­ä»£å™¨**ã€‚

æ—¢ç„¶å±äºè¿­ä»£å™¨ï¼Œé‚£å®ƒå°±å¯ä»¥ç”¨for...oféå†äº†å§ï¼Ÿ

å½“ç„¶æ²¡é”™ï¼Œä¸ä¿¡æ¥å†™ä¸€ä¸ªç®€å•çš„æ–æ³¢é‚£å¥‘æ•°åˆ—(50ä»¥å†…)ï¼š

    function* fibonacci(){
      let [prev, cur] = [0, 1];
      console.log(cur);
      while(true) {
        [prev, cur] = [cur, prev + cur];
        yield cur;
      }
    }
    
    for(let item of fibonacci()) {
      if(item > 50) break;
      console.log(item);
    }
    // 1
    // 1
    // 2
    // 3
    // 5
    // 8
    // 13
    // 21
    // 34
    å¤åˆ¶ä»£ç 

æ˜¯ä¸æ˜¯éå¸¸é…·ç‚«ï¼Ÿè¿™å°±æ˜¯è¿­ä»£å™¨çš„é­…åŠ›ï¼šï¼‰åŒæ—¶åˆå¯¹`ç”Ÿæˆå™¨`æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ï¼Œæ²¡æƒ³åˆ°æˆ‘ä»¬çš„è€ç†Ÿäºº`Generator`è¿˜æœ‰è¿™æ ·çš„èº«ä»½ã€‚

ä»¥ä¸Šä¾¿æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¯å‘ã€‚

ç»éªŒåˆ†äº«
----

### è¯»è€…çµé­‚ä¹‹é—®

å½“ä½ çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šåæ§½ï¼ŒJS å°±è¿™ä¹ˆç‚¹å†…å®¹å—ï¼Œå°±è¿™ä¹ˆå‡ ç¯‡å°±è®²å®Œäº†ï¼Ÿ

é¦–å…ˆæˆ‘è¦è¯´çš„æ˜¯ï¼Œçœ‹å®Œè¿™ä¸ªç³»åˆ—ï¼Œæˆ‘å¹¶ä¸èƒ½`ä¿è¯ä½ èƒ½æŒæ¡æ‰JSçš„æ‰€æœ‰å†…å®¹`ï¼Œæˆ‘ä¹Ÿç›¸ä¿¡æ²¡æœ‰å“ªä¸€ä¸ªç³»åˆ—ä¼šæ¶µç›–ä¸€é—¨è¯­è¨€æ‰€æœ‰çš„çŸ¥è¯†ç‚¹ï¼Œè€Œä¸”å­¦ä¹ æœ¬æ¥å°±æ˜¯ä¸€ä¸ªä¸æ–­å¾ªç¯å’Œè¿­ä»£çš„è¿‡ç¨‹ï¼Œå€˜è‹¥å“ªå¤©ä½ è§‰å¾—è‡ªå·±ç²¾é€šäº†ï¼Œå…¨éƒ¨äº†å¦‚æŒ‡æŒï¼Œæ²¡æœ‰å¿…è¦ç»§ç»­å­¦äº†ï¼Œé‚£æ‰æ˜¯çœŸæ­£çš„æ‚²å“€ã€‚

å› æ­¤ï¼Œå¦‚æœè¿™ä¸ªç³»åˆ—å¯¹ä½ èƒ½`äº§ç”ŸæŸç§å¯å‘`ï¼Œå¼¥è¡¥ä½ çš„ä¸€éƒ¨åˆ†`çŸ¥è¯†ç›²åŒº`ï¼Œæˆ–è€…å¯¹ä¹‹å‰æ¨¡ç³Šçš„æ¦‚å¿µé‡æ–°ç†è§£ï¼Œä»è€Œæœ‰äº†`æ·±åˆ»çš„è®¤è¯†`ï¼Œæˆ‘è§‰å¾—è¿™äº›æ–‡ç« çš„ä»·å€¼ä¹Ÿå°±çœŸæ­£å‘æŒ¥å‡ºæ¥äº†ã€‚

å¦å¤–å°±æ˜¯è¿™ä¸ªç³»åˆ—è¿˜ä¼šä¸æ–­çš„å¢æ·»å†…å®¹ï¼Œå°†ä¹‹å‰æœ‰æ‰€ç–æ¼çš„åœ°æ–¹ä¸€ä¸€è¡¥å……ä¸Šæ¥ï¼ŒæŠŠè¿™ä¸ªç³»åˆ—æ‰“é€ å¾—æ›´åŠ å®Œæ•´å’Œç³»ç»Ÿï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ç»™æˆ‘ææåç»­å†…å®¹æ–¹é¢çš„éœ€æ±‚ã€‚

### ç»éªŒä¹‹è°ˆ

åœ¨`å‰ç«¯`è¿™æ¡è·¯æ‘¸çˆ¬æ»šæ‰“ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œæ¥ä¸‹æ¥ï¼Œç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘è¿™äº›å¹´çš„å¿ƒå¾—å’Œä½“ä¼šå§ã€‚

é¦–å…ˆï¼Œå¯¹å‰ç«¯æ¥è®²ï¼Œä¸åƒ Javaï¼ŒC++è¿™äº›ç¼–ç¨‹é¢†åŸŸä¸­ç§‘ç­å‡ºèº«çš„äººé‚£ä¹ˆå¤šï¼Œä¸€éƒ¨åˆ†åŸå› æ˜¯å‰ç«¯é¢†åŸŸçš„çŸ¥è¯†å­¦æ ¡åŸºæœ¬ä¸æ•™ï¼Œå¦ä¸€æ–¹é¢ç§‘ç­æ¯•ä¸šçš„å¤§éƒ¨åˆ†å¹¶ä¸æƒ³åšè¿™ä¸€å—çš„å·¥ä½œã€‚

è¿™å°±å¯¼è‡´`åŠè·¯å‡ºå®¶`çš„å‰ç«¯eréå¸¸å¤šã€‚ä½†æ˜¯ä¹Ÿå¹¶ä¸ç”¨æ°”é¦ï¼Œæˆ‘æ˜¯è¿™ä¹ˆè§‰å¾—çš„:

> æˆä¸ºä¸€ä¸ªçœŸæ­£ä¸“ä¸šçš„äººï¼Œä¸åœ¨äºä½ æ˜¯ä¸æ˜¯æ‹¿åˆ°äº†ç§‘ç­æ–‡å‡­ï¼Œç”šè‡³ä¸åœ¨äºä½ æŒæ¡äº†å¤šå°‘äº®çœ¼çš„æŠ€æœ¯ï¼Œè€Œåœ¨äºä½ çš„å¤§è„‘ä¸­æ˜¯å¦æœ‰**å®Œæ•´çš„çŸ¥è¯†ä½“ç³»**ã€‚

è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œè¿™ä»½çŸ¥è¯†ä½“ç³»ç›¸å½“äºæ˜¯ä½ å¤§è„‘ä¸­çš„æ“ä½œç³»ç»Ÿï¼Œæœ‰äº†è¿™ä¸ªç³»ç»Ÿï¼Œç”¨å½“ä»Šæ¯”è¾ƒæ—¶é«¦çš„è¯æ¥å½¢å®¹å°±æ˜¯æœ‰äº†`ä½“ç³»åŒ–çš„æ€è€ƒèƒ½åŠ›`ï¼Œåœ¨åº”å¯¹å¤æ‚çš„é—®é¢˜æ‰ä¼šç«™åœ¨æ›´é«˜çš„é«˜åº¦å¯¹å„ä¸ªæ–¹é¢é‡‡å–ç»¼åˆæ€§çš„æƒè¡¡å’Œå–èˆï¼Œæˆ–è€…åœ¨åº”å¯¹æ–°æŠ€æœ¯çš„æ—¶å€™æœ‰è¶³å¤Ÿçš„è‡ªä¿¡å’Œèƒ½åŠ›å»å¿«é€Ÿæ‹¿ä¸‹ï¼Œè®©è¿™ä¸ªç³»ç»Ÿæ›´åŠ åšå›ºï¼Œæ€»ä¹‹è¿™ä¸ªç³»ç»Ÿä¼šåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¼´éšå’Œå½±å“è‡ªå·±ï¼Œå¦‚æœä¸å¥½å¥½å»ºè®¾ä¸€ä¸‹ï¼Œå¦‚èœ»èœ“ç‚¹æ°´ä¸€èˆ¬éšä¾¿å­¦ä¸€å †æŠ€æœ¯æ ˆï¼Œæˆ–è€…`ä¸‰å¤©æ‰“é±¼ä¸¤å¤©æ™’ç½‘`, æ²¡æœ‰**æŒç»­æ·±å…¥å­¦ä¹ **çš„æ¯…åŠ›ï¼Œç»“æœå°±æ˜¯å¤§è„‘ä¸­ç›¸å½“äºç¼ºå°‘ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå…¶å®æ˜¯æŒºå¯æ‚²çš„ä¸€ä»¶äº‹æƒ…ã€‚ä»¥å‰çš„æˆ‘æ€»æ˜¯å¯¹å„ç§æŠ€æœ¯è¶‹ä¹‹è‹¥é¹œï¼Œæ¨ä¸å¾—æŒæ¡æ‰€æœ‰çš„æŠ€æœ¯æ ˆï¼Œå› æ­¤ä¹Ÿæ€»æ˜¯å› ä¸ºæ—¶é—´ä¸å¤Ÿã€æ•ˆæœä¸å¥½è€Œç„¦è™‘ã€‚æœ€åçš„ç»“è®ºå°±æ˜¯ï¼šä»ä¸€å¼€å§‹å…³æ³¨ç‚¹å°±é”™äº†ï¼Œ**å…³æ³¨ç‚¹ä¸åº”åœ¨äºçœ¼èŠ±ç¼­ä¹±çš„æŠ€æœ¯ï¼Œè€Œåœ¨äºè‡ªèº«ç³»ç»Ÿçš„å»ºè®¾**ï¼Œè¿™æ ·å°±å¹¶ä¸ä¼šä¸ºxxxæŠ€æœ¯æˆ‘ä¸ä¼šè€Œæ„Ÿåˆ°ç„¦è™‘äº†ï¼Œç›¸åä¼šä¸ºè‡ªå·±ç‚¹æ»´çš„é¡¿æ‚Ÿå’Œè¿›æ­¥æ„Ÿåˆ°å…´å¥‹å’Œæ»¡è¶³ã€‚

ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æƒ³é€šäº†è¿™ä»¶äº‹æƒ…ï¼Œå¯èƒ½æ˜¯ä»¥å‰è¸©è¿‡å¤ªå¤šçš„å‘ï¼Œå¦å¤–ä¸€ä¸ªåŸå› ä¹Ÿåœ¨äºæœ¬äººçš„å±æœºæ„Ÿæ˜¯æ¯”è¾ƒå¼ºçš„ï¼Œæ‰ä¼šæœ‰ä¸€ç³»åˆ—çš„æŒ£æ‰å’Œæ€è€ƒã€‚

åŸºäºä»¥ä¸Šçš„`ä¿¡å¿µ`, æˆ‘å¼€å§‹äº†è¿™ä»½çŸ¥è¯†ä½“ç³»çš„å»ºè®¾ï¼Œè¿›åº¦æ¯å¤©ä¸æ–­åœ°æ¨è¿›ï¼Œè¿›è€Œä¹Ÿå°±è®©å¤§å®¶èƒ½å¤Ÿçœ‹åˆ°çœ¼å‰çš„åŸç”ŸJSçµé­‚ä¹‹é—®äº†ã€‚è¿™ä¸ªç³»åˆ—çš„ç”±æ¥æˆ‘åº”è¯¥è¯´æ¸…æ¥šäº†ï¼Œå¯èƒ½ä½ åˆè¦é—®äº†ï¼Œä¸æ˜¯æ¯å¤©è¿›åº¦éƒ½åœ¨æ¨è¿›ä¹ˆï¼Ÿé‚£å®Œæˆçš„ä¸œè¥¿æ”¾åœ¨å“ªå‘¢ï¼Ÿ

OKï¼Œè¿™å°±å¾—å…·ä½“ä»‹ç»ä¸€ä¸‹æˆ‘è¿™ä»½çŸ¥è¯†ä½“ç³»äº†ï¼Œæˆ‘æŠŠå®ƒæ”¾åœ¨äº†GitHubä¸Šï¼Œè™½ç„¶æ˜¯ä¸€ä¸ªå¹¶ä¸èµ·çœ¼çš„å¼€æºé¡¹ç›®ï¼Œä½†æ˜¯ä¹Ÿå°†æ˜¯å‡èšæˆ‘å¾ˆé•¿ä¸€æ®µæ—¶é—´å¿ƒè¡€çš„`ç³»ç»Ÿå»ºè®¾å·¥ç¨‹`ã€‚

[ç‚¹å‡»æŸ¥çœ‹GitHubä»“åº“](https://github.com/sanyuan0704/frontend_daily_question/blob/master/README.md)

ç›®å‰çš„å¤§çº²æ¢³ç†å¦‚ä¸‹:

å›¾ä¸­ç”¨çº¢æ——æ ‡è®°äº†å·²ç»å®Œæˆçš„éƒ¨åˆ†ï¼Œå³ä½¿å¦‚æ­¤ï¼Œåœ¨ä¹‹åä¹Ÿä¼šåšæ›´å¤šçš„è¡¥å……ï¼Œè®©çŸ¥è¯†ç»“æ„æ›´åŠ å®Œå–„ã€‚

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰é‚£ä¹ˆä¸€ä¸å¯å‘æˆ–è€…å¸®åŠ©ï¼Œä¹Ÿè¯·å¸®å¿™ç»™é¡¹ç›®ç‚¹ä¸€ä¸ª`star`, éå¸¸æ„Ÿè°¢ï¼

è¿™æ¬¡çš„åˆ†äº«å°±åˆ°è¿™é‡Œï¼Œå¦‚æœå¤§å®¶æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…æƒ³è¦ä¸æˆ‘å–å¾—è”ç³»ï¼Œè¯·åŠ wxï¼š`FESanyuan`ã€‚æˆ–è€…æ‰«ä¸‹é¢çš„ç åœ¨å…¬ä¼—å·ä¸­è·å¾—è”ç³»+åŠ ç¾¤æ–¹å¼ï¼Œä»¥è·å¾—æœ€æ–°èµ„è®¯å’ŒåŠ¨æ€ï¼šï¼‰

### å°å†Œé¢„å‘Š

å¦å¤–ï¼Œæˆ‘çš„æ˜é‡‘å°å†Œæœ€è¿‘ä¹Ÿä¼šä¸Šçº¿ï¼Œå…³äºreact hookså’Œimmutableæ•°æ®å®æˆ˜çš„æ•™ç¨‹ï¼Œé¡¹ç›®å·²å¼€æºï¼Œ[ç‚¹å‡»è·å–](https://github.com/sanyuan0704/react-cloud-music),ç›®å‰å’Œç®¡ç†å‘˜åå•†æš‚å®šä¸ºæœ¬å‘¨äº”ï¼Œæ•¬è¯·å…³æ³¨ã€‚

å‚è€ƒæ–‡çŒ®:

ã€Šæ·±å…¥æµ…å‡ºnodejsã€‹æœ´çµè‘—ã€‚

æå®¢æ—¶é—´ã€Šæµè§ˆå™¨å·¥ä½œåŸç†ä¸å®è·µã€‹

[åŒè¶Šã€Šæ·±å…¥ç†è§£JavaScriptå¼‚æ­¥ã€‹](https://github.com/wangfupeng1988/js-async-tutorial)

[æµè§ˆå™¨ä¸Nodeçš„äº‹ä»¶å¾ªç¯(Event Loop)æœ‰ä½•åŒºåˆ«?](https://juejin.im/post/5c337ae06fb9a049bc4cd218)

ã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡(ç¬¬ä¸‰ç‰ˆ)ã€‹

[ã€Šyckä¸ªäººåšå®¢ã€‹](https://yuchengkai.cn/blog/)